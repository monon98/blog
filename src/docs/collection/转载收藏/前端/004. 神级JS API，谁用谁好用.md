---
created: 2025-10-30T11:10:55 (UTC +08:00)
tags: [å‰ç«¯,JavaScriptä¸­æ–‡æŠ€æœ¯ç¤¾åŒº,å‰ç«¯å¼€å‘ç¤¾åŒº,å‰ç«¯æŠ€æœ¯äº¤æµ,å‰ç«¯æ¡†æ¶æ•™ç¨‹,JavaScript å­¦ä¹ èµ„æº,CSS æŠ€å·§ä¸æœ€ä½³å®è·µ,HTML5 æœ€æ–°åŠ¨æ€,å‰ç«¯å·¥ç¨‹å¸ˆèŒä¸šå‘å±•,å¼€æºå‰ç«¯é¡¹ç›®,å‰ç«¯æŠ€æœ¯è¶‹åŠ¿]
source: https://juejin.cn/post/7564307224266211343
author: 1_2_3_4
---

# ç¥çº§JS APIï¼Œè°ç”¨è°å¥½ç”¨

å‰ç«¯åœˆä¸€å¹´Â **365**Â å¤©ï¼Œå¤©å¤©å‡ºæ–°æ¡†æ¶ï¼Œä½†çœŸæ­£èƒ½è®©ä½ **å°‘å†™ä»£ç ã€å°‘å¼•ä¾èµ–ã€å°‘è¸©æ€§èƒ½å‘**çš„ï¼Œå…¶å®æ˜¯æµè§ˆå™¨çˆ¸çˆ¸æ—©å·²å·å·å†…ç½®çš„ã€Œ**åŸç”Ÿå¤–æŒ‚**ã€ã€‚

## 1\. ResizeObserver

`ResizeObserver` æ˜¯ä¸€ä¸ªæµè§ˆå™¨åŸç”Ÿçš„ JavaScript APIï¼Œç”¨äº**ç›‘å¬ DOM å…ƒç´ å°ºå¯¸çš„å˜åŒ–**ã€‚å®ƒç±»ä¼¼äº `MutationObserver`ï¼Œä½†ä¸“é—¨ç”¨äºè§‚å¯Ÿå…ƒç´ çš„å¤§å°ï¼ˆå®½é«˜ï¼‰å˜åŒ–ï¼Œè€Œæ— éœ€ä¾èµ– `window.resize` äº‹ä»¶ï¼ˆåè€…åªå¯¹è§†å£å˜åŒ–æœ‰æ•ˆï¼‰ã€‚

### ğŸ§© åŸºæœ¬ç”¨æ³•

```javascript
const resizeObserver = new ResizeObserver(entries => {
  for (let entry of entries) {
    const { width, height } = entry.contentRect;
    console.log(`å…ƒç´ å°ºå¯¸ï¼š${width} x ${height}`);
    
    // entry.target æ˜¯è¢«è§‚å¯Ÿçš„ DOM å…ƒç´ 
    console.log('ç›®æ ‡å…ƒç´ :', entry.target);
  }
});

// å¼€å§‹è§‚å¯ŸæŸä¸ªå…ƒç´ 
resizeObserver.observe(document.querySelector('#my-element'));

// å¯é€‰ï¼šè§‚å¯Ÿå¤šä¸ªå…ƒç´ 
// resizeObserver.observe(element1);
// resizeObserver.observe(element2);
```

### ğŸ“¦ entry.contentRect vs getBoundingClientRect()

-   `entry.contentRect`ï¼šè¡¨ç¤º**å†…å®¹åŒºåŸŸ**ï¼ˆä¸åŒ…æ‹¬ paddingã€borderã€marginï¼‰ï¼Œç±»ä¼¼äºÂ `getComputedStyle().width/height`Â çš„è®¡ç®—ç»“æœã€‚
-   å¦‚æœä½ éœ€è¦åŒ…æ‹¬ border å’Œ padding çš„å°ºå¯¸ï¼Œå¯ä»¥ç»“åˆÂ `entry.target.getBoundingClientRect()`Â ä½¿ç”¨ã€‚

### ğŸ›‘ åœæ­¢è§‚å¯Ÿ

```scss
// åœæ­¢è§‚å¯ŸæŸä¸ªå…ƒç´ 
resizeObserver.unobserve(element);

// åœæ­¢è§‚å¯Ÿæ‰€æœ‰å…ƒç´ å¹¶é‡Šæ”¾èµ„æº
resizeObserver.disconnect();
```

> **å»ºè®®**ï¼šåœ¨ç»„ä»¶é”€æ¯ï¼ˆå¦‚ React çš„ `useEffect` æ¸…ç†å‡½æ•°ã€Vue çš„ `onBeforeUnmount`ï¼‰æ—¶è°ƒç”¨ `disconnect()`ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚

### âœ… ä½¿ç”¨åœºæ™¯

1.  **å“åº”å¼ç»„ä»¶**ï¼šå½“å®¹å™¨å°ºå¯¸å˜åŒ–æ—¶åŠ¨æ€è°ƒæ•´å­å…ƒç´ ï¼ˆå¦‚å›¾è¡¨ã€Canvasã€è§†é¢‘ï¼‰ã€‚
2.  **è‡ªå®šä¹‰æ»šåŠ¨æ¡æˆ–å¸ƒå±€**ï¼šç›‘å¬å†…å®¹åŒºåŸŸå˜åŒ–ä»¥æ›´æ–° UIã€‚
3.  **æ›¿ä»£Â `window.onresize`**ï¼šæ›´ç²¾ç¡®åœ°å“åº”**ç‰¹å®šå…ƒç´ **çš„å°ºå¯¸å˜åŒ–ï¼Œè€Œéæ•´ä¸ªçª—å£ã€‚
4.  **Web Components / å°è£…ç»„ä»¶**ï¼šå†…éƒ¨è‡ªåŠ¨é€‚é…çˆ¶å®¹å™¨å¤§å°ã€‚

### ğŸŒ æµè§ˆå™¨å…¼å®¹æ€§

-   âœ… Chrome 64+
-   âœ… Firefox 69+
-   âœ… Safari 13.1+
-   âœ… Edge 79+
-   âŒ IE ä¸æ”¯æŒï¼ˆéœ€ polyfillï¼‰

> å…¼å®¹æ€§å·²éå¸¸å¹¿æ³›ï¼Œç°ä»£é¡¹ç›®å¯æ”¾å¿ƒä½¿ç”¨ã€‚

### ğŸ› ï¸ Polyfillï¼ˆå¦‚éœ€æ”¯æŒæ—§æµè§ˆå™¨ï¼‰

å¯é€šè¿‡ [GitHub - juggle/resize-observer](https://link.juejin.cn/?target=) æä¾›çš„ polyfillï¼š

```bash
npm install @juggle/resize-observer
```

```javascript
import ResizeObserver from '@juggle/resize-observer';

// å¦‚æœåŸç”Ÿä¸æ”¯æŒï¼Œåˆ™ä½¿ç”¨ polyfill
if (!window.ResizeObserver) {
  window.ResizeObserver = ResizeObserver;
}
```

### ç¤ºä¾‹ï¼šReact ä¸­ä½¿ç”¨

```javascript
import { useEffect, useRef } from 'react';

function MyComponent() {
  const containerRef = useRef(null);

  useEffect(() => {
    const observer = new ResizeObserver(entries => {
      for (let entry of entries) {
        console.log('æ–°å®½åº¦:', entry.contentRect.width);
      }
    });

    if (containerRef.current) {
      observer.observe(containerRef.current);
    }

    return () => {
      observer.disconnect(); // æ¸…ç†
    };
  }, []);

  return <div ref={containerRef}>å¯å˜å°ºå¯¸å®¹å™¨</div>;
}
```

## 2.IntersectionObserver

`IntersectionObserver` æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æµè§ˆå™¨åŸç”Ÿ APIï¼Œç”¨äº**å¼‚æ­¥ç›‘å¬ç›®æ ‡å…ƒç´ ä¸ç¥–å…ˆå…ƒç´ ï¼ˆæˆ–è§†å£ï¼‰çš„äº¤å‰ï¼ˆç›¸äº¤ï¼‰çŠ¶æ€å˜åŒ–**ã€‚å®ƒå¸¸ç”¨äºå®ç°**æ‡’åŠ è½½ã€æ— é™æ»šåŠ¨ã€æ›å…‰ç»Ÿè®¡ã€åŠ¨ç”»è§¦å‘**ç­‰åœºæ™¯ï¼Œæ€§èƒ½è¿œä¼˜äºä¼ ç»Ÿçš„ `scroll` äº‹ä»¶ç›‘å¬ã€‚

### ğŸ§© åŸºæœ¬ç”¨æ³•

```javascript
const observer = new IntersectionObserver((entries, observer) => {
  entries.forEach(entry => {
    // entry.targetï¼šè¢«è§‚å¯Ÿçš„ DOM å…ƒç´ 
    // entry.isIntersectingï¼šæ˜¯å¦ä¸æ ¹ï¼ˆviewport æˆ– rootï¼‰ç›¸äº¤
    // entry.intersectionRatioï¼šç›¸äº¤åŒºåŸŸå ç›®æ ‡å…ƒç´ çš„æ¯”ä¾‹ï¼ˆ0 ~ 1ï¼‰
    // entry.intersectionRectï¼šç›¸äº¤åŒºåŸŸçš„çŸ©å½¢ä¿¡æ¯
    // entry.boundingClientRectï¼šç›®æ ‡å…ƒç´ ç›¸å¯¹äºè§†å£çš„ä½ç½®
    // entry.rootBoundsï¼šæ ¹å…ƒç´ çš„è¾¹ç•Œï¼ˆé€šå¸¸æ˜¯è§†å£ï¼‰

    if (entry.isIntersecting) {
      console.log('å…ƒç´ è¿›å…¥è§†å£:', entry.target);
      // ä¾‹å¦‚ï¼šåŠ è½½å›¾ç‰‡ã€è§¦å‘åŠ¨ç”»
    } else {
      console.log('å…ƒç´ ç¦»å¼€è§†å£');
    }
  });
});

// å¼€å§‹è§‚å¯ŸæŸä¸ªå…ƒç´ 
observer.observe(document.querySelector('#my-element'));
```

### âš™ï¸ é…ç½®é€‰é¡¹ï¼ˆå¯é€‰ï¼‰

```csharp
const options = {
  root: null, // é»˜è®¤ä¸ºè§†å£ï¼ˆviewportï¼‰ï¼›å¯è®¾ä¸ºæŸä¸ªç¥–å…ˆå…ƒç´ 
  rootMargin: '0px', // ç±»ä¼¼ CSS marginï¼Œæ‰©å±•æˆ–æ”¶ç¼©æ ¹çš„è¾¹ç•Œï¼ˆæ”¯æŒè´Ÿå€¼ï¼‰
  threshold: 0.5 // è§¦å‘å›è°ƒçš„ç›¸äº¤æ¯”ä¾‹é˜ˆå€¼ï¼ˆ0 ~ 1ï¼‰ï¼Œå¯ä¸ºæ•°å­—æˆ–æ•°ç»„
};

const observer = new IntersectionObserver(callback, options);
```

#### `threshold`Â ç¤ºä¾‹ï¼š

-   `threshold: 0`ï¼šåªè¦æœ‰ä¸€ç‚¹è¿›å…¥å°±è§¦å‘ï¼ˆé»˜è®¤ï¼‰ã€‚
-   `threshold: 1`ï¼šå®Œå…¨è¿›å…¥æ‰è§¦å‘ã€‚
-   `threshold: [0, 0.25, 0.5, 0.75, 1]`ï¼šåœ¨ 0%ã€25%ã€50%... æ—¶éƒ½è§¦å‘ã€‚

### ğŸ›‘ åœæ­¢è§‚å¯Ÿ

```scss
javascript
ç¼–è¾‘
observer.unobserve(element); // åœæ­¢å•ä¸ªå…ƒç´ 
observer.disconnect();      // åœæ­¢æ‰€æœ‰å¹¶é‡Šæ”¾èµ„æº
```

> **å»ºè®®**ï¼šåœ¨ç»„ä»¶é”€æ¯æ—¶è°ƒç”¨ `disconnect()`ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚

### âœ… å…¸å‹åº”ç”¨åœºæ™¯

#### 1.Â **å›¾ç‰‡æ‡’åŠ è½½**

```javascript
const imgObserver = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const img = entry.target;
      img.src = img.dataset.src; // ä» data-src åŠ è½½çœŸå®å›¾ç‰‡
      imgObserver.unobserve(img); // åŠ è½½ååœæ­¢è§‚å¯Ÿ
    }
  });
});

document.querySelectorAll('img[data-src]').forEach(img => {
  imgObserver.observe(img);
});
```

#### 2.Â **æ»šåŠ¨åˆ°åº•éƒ¨è‡ªåŠ¨åŠ è½½ï¼ˆæ— é™æ»šåŠ¨ï¼‰**

è§‚å¯Ÿä¸€ä¸ªâ€œå“¨å…µâ€å…ƒç´ ï¼ˆå¦‚åˆ†é¡µåŠ è½½æç¤ºï¼‰ï¼Œå½“å®ƒè¿›å…¥è§†å£æ—¶è§¦å‘åŠ è½½ã€‚

#### 3.Â **æ›å…‰åŸ‹ç‚¹ / å¹¿å‘Šå¯è§æ€§ç»Ÿè®¡**

å½“å¹¿å‘Šæˆ–å†…å®¹åŒºåŸŸè¿›å…¥è§†å£ä¸€å®šæ¯”ä¾‹æ—¶ï¼Œä¸ŠæŠ¥â€œæ›å…‰â€äº‹ä»¶ã€‚

#### 4.Â **æ»šåŠ¨åŠ¨ç”»ï¼ˆå¦‚ AOS æ•ˆæœï¼‰**

å…ƒç´ è¿›å…¥è§†å£æ—¶æ·»åŠ  CSS åŠ¨ç”»ç±»ã€‚

### ğŸŒ æµè§ˆå™¨å…¼å®¹æ€§

-   âœ… Chrome 51+
-   âœ… Firefox 55+
-   âœ… Safari 12.1+
-   âœ… Edge 15+
-   âŒ IE ä¸æ”¯æŒï¼ˆéœ€ polyfillï¼‰

> ç°ä»£æµè§ˆå™¨æ”¯æŒè‰¯å¥½ï¼Œç§»åŠ¨ç«¯ä¹Ÿå¹¿æ³›å¯ç”¨ã€‚

### ğŸ› ï¸ Polyfillï¼ˆå…¼å®¹æ—§æµè§ˆå™¨ï¼‰

å®˜æ–¹æ¨è polyfillï¼ˆç”± W3C å›¢é˜Ÿç»´æŠ¤ï¼‰ï¼š

```sql
npm install intersection-observer
```

```go
// åœ¨åº”ç”¨å…¥å£å¼•å…¥ï¼ˆè‡ªåŠ¨å¡«å…… window.IntersectionObserverï¼‰
import 'intersection-observer';
```

> æ³¨æ„ï¼špolyfill ä¼šå›é€€åˆ° `scroll` + `getBoundingClientRect()`ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œä»…ç”¨äºå…¼å®¹ã€‚

___

### ğŸ’¡ ä¸Â `ResizeObserver`Â /Â `MutationObserver`Â å¯¹æ¯”

|         API          |          ç”¨é€”          |
|----------------------|----------------------|
| `IntersectionObserver` | ç›‘å¬å…ƒç´ æ˜¯å¦è¿›å…¥/ç¦»å¼€è§†å£ï¼ˆæˆ–æŒ‡å®šå®¹å™¨ï¼‰ |
|    `ResizeObserver`    |       ç›‘å¬å…ƒç´ å°ºå¯¸å˜åŒ–       |
|   `MutationObserver`   |    ç›‘å¬ DOM ç»“æ„æˆ–å±æ€§å˜åŒ–    |

ä¸‰è€…äº’è¡¥ï¼Œå¸¸ç»“åˆä½¿ç”¨ã€‚

### ğŸ“Œ å°æŠ€å·§

-   ä½¿ç”¨Â `rootMargin: '100px'`Â å¯ä»¥**æå‰è§¦å‘**ï¼ˆåœ¨å…ƒç´ è·ç¦»è§†å£è¿˜æœ‰ 100px æ—¶å°±åŠ è½½ï¼‰ã€‚
-   åœ¨Â `<img loading="lazy">`Â æ™®åŠçš„ä»Šå¤©ï¼Œç®€å•å›¾ç‰‡æ‡’åŠ è½½å¯ç›´æ¥ç”¨ HTML å±æ€§ï¼Œä½†å¤æ‚é€»è¾‘ä»éœ€Â `IntersectionObserver`ã€‚

## 3.Page Visibility

`Page Visibility API` æ˜¯ä¸€ä¸ªæµè§ˆå™¨åŸç”Ÿ APIï¼Œç”¨äºæ£€æµ‹**å½“å‰ç½‘é¡µæ˜¯å¦å¯¹ç”¨æˆ·å¯è§**ï¼ˆå³æ˜¯å¦å¤„äºå‰å°æ ‡ç­¾é¡µæˆ–è¢«æœ€å°åŒ–/åˆ‡æ¢åˆ°åå°ï¼‰ã€‚å®ƒå¯ä»¥å¸®åŠ©å¼€å‘è€…ä¼˜åŒ–æ€§èƒ½ã€èŠ‚çœèµ„æºï¼Œæˆ–å®ç°ç‰¹å®šä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚æš‚åœè§†é¢‘ã€åœæ­¢è½®è¯¢ã€ç»Ÿè®¡åœç•™æ—¶é•¿ç­‰ï¼‰ã€‚

___

### ğŸ§© æ ¸å¿ƒå±æ€§ä¸äº‹ä»¶

#### 1.Â `document.visibilityState`

è¿”å›å½“å‰é¡µé¢çš„å¯è§æ€§çŠ¶æ€ï¼Œå¯èƒ½å€¼åŒ…æ‹¬ï¼š

|      å€¼      |            å«ä¹‰             |
|-------------|---------------------------|
|  `'visible'`  |       é¡µé¢å¯è§ï¼ˆå¤„äºå‰å°æ ‡ç­¾é¡µï¼‰       |
|  `'hidden'`   | é¡µé¢ä¸å¯è§ï¼ˆåˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µã€æœ€å°åŒ–çª—å£ã€é”å±ç­‰ï¼‰ |
| `'prerender'` |  é¡µé¢æ­£åœ¨é¢„æ¸²æŸ“ï¼ˆå·²åºŸå¼ƒï¼Œç°ä»£æµè§ˆå™¨åŸºæœ¬ä¸ç”¨ï¼‰   |
| `'unloaded'`  |       é¡µé¢å³å°†å¸è½½ï¼ˆæå°‘ä½¿ç”¨ï¼‰        |

> å®é™…å¼€å‘ä¸­ä¸»è¦å…³æ³¨ `'visible'` å’Œ `'hidden'`ã€‚

#### 2.Â `document.hidden`ï¼ˆå·²åºŸå¼ƒï¼Œå»ºè®®ç”¨Â `visibilityState`ï¼‰

-   `true`ï¼šé¡µé¢ä¸å¯è§
-   `false`ï¼šé¡µé¢å¯è§

> âš ï¸ è™½ä»å¯ç”¨ï¼Œä½† MDN å»ºè®®ä½¿ç”¨ `visibilityState`ã€‚

#### 3.Â `visibilitychange`Â äº‹ä»¶

å½“é¡µé¢å¯è§æ€§çŠ¶æ€æ”¹å˜æ—¶è§¦å‘ã€‚

### âœ… åŸºæœ¬ç”¨æ³•ç¤ºä¾‹

```javascript
function handleVisibilityChange() {
  if (document.visibilityState === 'visible') {
    console.log('é¡µé¢å›åˆ°å‰å°');
    // æ¢å¤è§†é¢‘æ’­æ”¾ã€é‡å¯å®šæ—¶å™¨ã€åˆ·æ–°æ•°æ®ç­‰
  } else if (document.visibilityState === 'hidden') {
    console.log('é¡µé¢è¿›å…¥åå°');
    // æš‚åœè§†é¢‘ã€åœæ­¢è½®è¯¢ã€ä¿å­˜çŠ¶æ€ç­‰
  }
}

// ç›‘å¬å¯è§æ€§å˜åŒ–
document.addEventListener('visibilitychange', handleVisibilityChange);
```

### ğŸŒŸ å…¸å‹åº”ç”¨åœºæ™¯

#### 1.Â **æš‚åœ/æ¢å¤åª’ä½“æ’­æ”¾**

```javascript
const video = document.querySelector('video');

document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    video.pause();
  } else {
    video.play();
  }
});
```

#### 2.Â **åœæ­¢ä¸å¿…è¦çš„è½®è¯¢æˆ–å®šæ—¶ä»»åŠ¡**

```javascript
let intervalId;

function startPolling() {
  intervalId = setInterval(fetchData, 5000);
}

function stopPolling() {
  clearInterval(intervalId);
}

document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    stopPolling();
  } else {
    startPolling();
  }
});

startPolling(); // åˆå§‹å¯åŠ¨
```

#### 3.Â **ç”¨æˆ·åœç•™æ—¶é•¿ç»Ÿè®¡**

```javascript
let startTime = Date.now();
let totalVisibleTime = 0;

document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    totalVisibleTime += Date.now() - startTime;
  } else {
    startTime = Date.now();
  }
});

// é¡µé¢å¸è½½æ—¶ä¸ŠæŠ¥æ€»å¯è§æ—¶é•¿
window.addEventListener('beforeunload', () => {
  totalVisibleTime += Date.now() - startTime;
  sendToAnalytics({ visibleTime: totalVisibleTime });
});
```

#### 4.Â **èŠ‚çœèµ„æºï¼ˆå¦‚ Canvas åŠ¨ç”»ã€WebGLï¼‰**

åœ¨é¡µé¢ä¸å¯è§æ—¶æš‚åœæ¸²æŸ“å¾ªç¯ï¼Œå‡å°‘ CPU/GPU æ¶ˆè€—ã€‚

### ğŸŒ æµè§ˆå™¨å…¼å®¹æ€§

-   âœ… Chrome 13+
-   âœ… Firefox 10+
-   âœ… Safari 7+
-   âœ… Edge 12+
-   âœ… iOS Safari / Android Browserï¼ˆç°ä»£ç‰ˆæœ¬ï¼‰

> å…¼å®¹æ€§æä½³ï¼Œå‡ ä¹æ‰€æœ‰ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒã€‚

### âš ï¸ æ³¨æ„äº‹é¡¹

-   **ä¸ä¿è¯ç²¾ç¡®æ€§**ï¼šåœ¨æŸäº›ç³»ç»Ÿï¼ˆå¦‚ macOS å¿«é€Ÿåˆ‡æ¢ï¼‰ä¸­ï¼ŒçŠ¶æ€åˆ‡æ¢å¯èƒ½æœ‰å¾®å°å»¶è¿Ÿã€‚
    
-   **ä¸æ˜¯ç”¨æˆ·æ´»è·ƒåº¦æ£€æµ‹**ï¼šé¡µé¢å¯è§ â‰  ç”¨æˆ·æ­£åœ¨çœ‹ï¼ˆç”¨æˆ·å¯èƒ½åˆ‡åˆ°å…¶ä»–åº”ç”¨ä½†æµè§ˆå™¨çª—å£ä»åœ¨å‰å°ï¼‰ã€‚
    
-   **ä¸Â `blur`/`focus`Â äº‹ä»¶çš„åŒºåˆ«**ï¼š
    
    -   `window.onfocus`Â /Â `window.onblur`ï¼šç›‘å¬**çª—å£ç„¦ç‚¹**ï¼ˆå¦‚åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨ï¼‰ã€‚
    -   `visibilitychange`ï¼šç›‘å¬**æ ‡ç­¾é¡µæ˜¯å¦å¯è§**ï¼ˆå³ä½¿çª—å£æœ‰ç„¦ç‚¹ï¼Œä½†æ ‡ç­¾é¡µåœ¨åå°ä¹Ÿç®— hiddenï¼‰ã€‚
    -   ä¸¤è€…å¯ç»“åˆä½¿ç”¨ä»¥è·å¾—æ›´å…¨é¢çš„çŠ¶æ€åˆ¤æ–­ã€‚

___

### ğŸ” æ‰©å±•ï¼šç»“åˆÂ `focus`/`blur`Â æ›´ç²¾å‡†åˆ¤æ–­

```javascript
let isPageVisible = !document.hidden;
let isWindowFocused = !document.hasFocus();

window.addEventListener('focus', () => {
  isWindowFocused = true;
  if (isPageVisible) {
    console.log('ç”¨æˆ·å¾ˆå¯èƒ½æ­£åœ¨çœ‹é¡µé¢');
  }
});

window.addEventListener('blur', () => {
  isWindowFocused = false;
});

document.addEventListener('visibilitychange', () => {
  isPageVisible = !document.hidden;
});
```

## 4.Web Share API

`Web Share API` æ˜¯ä¸€ä¸ªç°ä»£æµè§ˆå™¨æä¾›çš„åŸç”Ÿ APIï¼Œå…è®¸ç½‘é¡µ**è°ƒç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„åˆ†äº«åŠŸèƒ½**ï¼Œè®©ç”¨æˆ·å°†å†…å®¹ï¼ˆå¦‚é“¾æ¥ã€æ–‡æœ¬ã€æ ‡é¢˜ç­‰ï¼‰å¿«é€Ÿåˆ†äº«åˆ°è®¾å¤‡ä¸Šå®‰è£…çš„å…¶ä»–åº”ç”¨ï¼ˆå¦‚å¾®ä¿¡ã€é‚®ä»¶ã€çŸ­ä¿¡ã€ç¬”è®°ç­‰ï¼‰ã€‚

### âœ… åŸºæœ¬ç”¨æ³•

```javascript
if (navigator.share) {
  navigator.share({
    title: 'åˆ†äº«æ ‡é¢˜',
    text: 'åˆ†äº«çš„æè¿°æ–‡å­—',
    url: 'https://example.com'
  })
  .then(() => {
    console.log('åˆ†äº«æˆåŠŸ');
  })
  .catch((error) => {
    if (error.name === 'AbortError') {
      console.log('ç”¨æˆ·å–æ¶ˆäº†åˆ†äº«');
    } else {
      console.error('åˆ†äº«å¤±è´¥:', error);
    }
  });
} else {
  // å›é€€æ–¹æ¡ˆï¼šæ˜¾ç¤ºè‡ªå®šä¹‰åˆ†äº«æŒ‰é’®æˆ–æç¤º
  alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Web Share APIï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
}
```

> âš ï¸ **å¿…é¡»åœ¨ç”¨æˆ·æ‰‹åŠ¿è§¦å‘çš„ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨**ï¼ˆå¦‚ç‚¹å‡»äº‹ä»¶ï¼‰ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå®‰å…¨é”™è¯¯ã€‚

___

### ğŸ” å®‰å…¨ä¸é™åˆ¶

-   **ä»…é™å®‰å…¨ä¸Šä¸‹æ–‡**ï¼šå¿…é¡»åœ¨Â `HTTPS`ï¼ˆæˆ–Â `localhost`ï¼‰ä¸‹ä½¿ç”¨ã€‚
-   **ç”¨æˆ·æ‰‹åŠ¿è¦æ±‚**ï¼šåªèƒ½åœ¨Â `click`ã€`touchend`Â ç­‰ç”¨æˆ·æ“ä½œå›è°ƒä¸­è°ƒç”¨ã€‚
-   **å­—æ®µéå…¨éƒ¨å¿…éœ€**ï¼šä½†è‡³å°‘è¦æä¾›Â `title`ã€`text`ã€`url`Â ä¸­çš„ä¸€ä¸ªï¼ˆæ¨èæä¾›Â `url`ï¼‰ã€‚
-   **æ— æ³•æ§åˆ¶ç›®æ ‡åº”ç”¨**ï¼šåˆ†äº«ç›®æ ‡ç”±æ“ä½œç³»ç»Ÿå†³å®šï¼Œå¼€å‘è€…æ— æ³•æŒ‡å®šï¼ˆå¦‚â€œåªåˆ†äº«åˆ°å¾®ä¿¡â€ï¼‰ã€‚

### ğŸ“± æ”¯æŒæƒ…å†µï¼ˆæˆªè‡³ 2025 å¹´ï¼‰

|   å¹³å°    |          æµè§ˆå™¨          |      æ”¯æŒæƒ…å†µ      |
|---------|-----------------------|----------------|
| Android |      Chrome 61+       |     âœ… å®Œæ•´æ”¯æŒ     |
|   iOS   |     Safari 12.2+      | âœ…ï¼ˆéœ€ iOS 12.2+ï¼‰ |
| Windows | Chrome 76+ / Edge 79+ |  âœ…ï¼ˆè°ƒç”¨ç³»ç»Ÿåˆ†äº«é¢æ¿ï¼‰   |
|  macOS  |  Safari 13+ / Chrome  |    âœ…ï¼ˆéƒ¨åˆ†ç‰ˆæœ¬ï¼‰     |
|  Linux  |         éƒ¨åˆ†æµè§ˆå™¨         |    âš ï¸ æœ‰é™æ”¯æŒ     |

> å¯é€šè¿‡ [caniuse.com/web-share](https://link.juejin.cn/?target=) æŸ¥çœ‹æœ€æ–°å…¼å®¹æ€§ã€‚

### ğŸ§© é«˜çº§ç”¨æ³•ï¼šåˆ†äº«æ–‡ä»¶ï¼ˆWeb Share API Level 2ï¼‰

ç°ä»£æµè§ˆå™¨ï¼ˆChrome 89+ ç­‰ï¼‰æ”¯æŒåˆ†äº«**æ–‡ä»¶**ï¼ˆå¦‚å›¾ç‰‡ã€PDFï¼‰ï¼š

```csharp
if (navigator.canShare && navigator.canShare({ files: [file] })) {
  await navigator.share({
    title: 'å›¾ç‰‡åˆ†äº«',
    files: [file] // File å¯¹è±¡æ•°ç»„
  });
}
```

> æ³¨æ„ï¼šæ–‡ä»¶å¿…é¡»æ¥è‡ªç”¨æˆ·é€‰æ‹©ï¼ˆå¦‚ `<input type="file">`ï¼‰æˆ–ç”±ç½‘é¡µç”Ÿæˆï¼Œä¸èƒ½æ˜¯ä»»æ„ç½‘ç»œæ–‡ä»¶ã€‚

### ğŸ”„ å›é€€æ–¹æ¡ˆï¼ˆFallbackï¼‰

å½“ä¸æ”¯æŒ Web Share æ—¶ï¼Œå¯æä¾›å¤åˆ¶é“¾æ¥æˆ–è‡ªå®šä¹‰åˆ†äº«æŒ‰é’®ï¼š

```lua
function fallbackShare(url) {
  const input = document.createElement('input');
  input.value = url;
  document.body.appendChild(input);
  input.select();
  document.execCommand('copy');
  document.body.removeChild(input);
  alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
}
```

___

### ğŸ“¦ åœ¨æ¡†æ¶ä¸­ä½¿ç”¨ï¼ˆReact ç¤ºä¾‹ï¼‰

```javascript
function ShareButton({ url, title, text }) {
  const handleShare = async () => {
    if (navigator.share) {
      try {
        await navigator.share({ url, title, text });
      } catch (err) {
        console.warn('åˆ†äº«è¢«å–æ¶ˆæˆ–å¤±è´¥', err);
      }
    } else {
      fallbackShare(url);
    }
  };

  return (
    <button onClick={handleShare}>
      åˆ†äº«
    </button>
  );
}
```

___

### ğŸš€ ä¼˜åŠ¿

-   **åŸç”Ÿä½“éªŒ**ï¼šä½¿ç”¨ç³»ç»Ÿåˆ†äº«é¢æ¿ï¼Œç”¨æˆ·ç†Ÿæ‚‰ä¸”æ”¯æŒæ‰€æœ‰å·²å®‰è£…åº”ç”¨ã€‚
-   **æ— éœ€ç¬¬ä¸‰æ–¹ SDK**ï¼šé¿å…é›†æˆå¾®ä¿¡ã€å¾®åšç­‰ SDK çš„å¤æ‚æ€§ã€‚
-   **éšç§å‹å¥½**ï¼šä¸æ”¶é›†ç”¨æˆ·åˆ†äº«è¡Œä¸ºæ•°æ®ï¼ˆé™¤éä½ è‡ªå·±ä¸ŠæŠ¥ï¼‰ã€‚

___

### ğŸ“Œ å°è´´å£«

-   æµ‹è¯•æ—¶å¯åœ¨ Chrome DevTools çš„Â **Device Modeï¼ˆè®¾å¤‡æ¨¡æ‹Ÿï¼‰** Â ä¸­æŸ¥çœ‹åˆ†äº«å¼¹çª—ã€‚
-   åœ¨ PWA ä¸­ä½¿ç”¨æ•ˆæœæœ€ä½³ï¼Œå¯å®ç°â€œç±»åŸç”Ÿâ€åˆ†äº«ä½“éªŒã€‚

## 5\. Wake Lock

`Wake Lock API` æ˜¯ä¸€ä¸ªç°ä»£ Web APIï¼Œå…è®¸ç½‘é¡µ**é˜²æ­¢è®¾å¤‡è¿›å…¥ä¼‘çœ çŠ¶æ€**ï¼ˆå¦‚å±å¹•å˜æš—ã€é”å±ï¼‰ï¼Œå¸¸ç”¨äºéœ€è¦é•¿æ—¶é—´ä¿æŒæ´»è·ƒçš„åœºæ™¯ï¼Œä¾‹å¦‚ï¼š

-   è§†é¢‘æ’­æ”¾å™¨ï¼ˆé¿å…æ’­æ”¾æ—¶å±å¹•å…³é—­ï¼‰
-   å¯¼èˆªåº”ç”¨ï¼ˆæŒç»­æ˜¾ç¤ºè·¯çº¿ï¼‰
-   æ‰«ç /AR åº”ç”¨ï¼ˆä¿æŒæ‘„åƒå¤´æ´»è·ƒï¼‰
-   é˜…è¯»å™¨/ç”µå­ä¹¦ï¼ˆé•¿æ—¶é—´é˜…è¯»ä¸é”å±ï¼‰

### ğŸ”’ ä¸¤ç§é”ç±»å‹ï¼ˆç›®å‰ä¸»è¦æ”¯æŒÂ `screen`ï¼‰

```cpp
// 1. Screen Wake Lockï¼ˆå±å¹•å”¤é†’é”ï¼‰ â† å½“å‰å”¯ä¸€å¹¿æ³›æ”¯æŒçš„ç±»å‹
// 2. System Wake Lockï¼ˆç³»ç»Ÿå”¤é†’é”ï¼‰ â† å°šæœªæ ‡å‡†åŒ–ï¼ŒåŸºæœ¬ä¸å¯ç”¨
```

> ç›®å‰ **åªæœ‰ `screen` ç±»å‹** åœ¨ä¸»æµæµè§ˆå™¨ä¸­å¯ç”¨ã€‚

___

### âœ… åŸºæœ¬ç”¨æ³•ï¼ˆScreen Wake Lockï¼‰

```javascript
let wakeLock = null;

async function requestWakeLock() {
  try {
    // è¯·æ±‚å±å¹•å”¤é†’é”
    wakeLock = await navigator.wakeLock.request('screen');
    console.log('Wake Lock å·²æ¿€æ´»');

    // ç›‘å¬é‡Šæ”¾äº‹ä»¶ï¼ˆå¦‚é¡µé¢éšè—ã€ç”¨æˆ·é”å±ï¼‰
    wakeLock.addEventListener('release', () => {
      console.log('Wake Lock å·²é‡Šæ”¾');
    });

  } catch (err) {
    console.error('Wake Lock è¯·æ±‚å¤±è´¥:', err);
  }
}

// åœ¨ç”¨æˆ·äº¤äº’åè°ƒç”¨ï¼ˆå¦‚ç‚¹å‡»æŒ‰é’®ï¼‰
document.getElementById('keepAwakeBtn').addEventListener('click', requestWakeLock);
```

> âš ï¸ **å¿…é¡»ç”±ç”¨æˆ·æ‰‹åŠ¿è§¦å‘**ï¼ˆå¦‚ `click`ï¼‰ï¼Œä¸èƒ½åœ¨é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¯·æ±‚ã€‚

___

### ğŸ›‘ é‡Šæ”¾é”ï¼ˆå¯é€‰ï¼Œé€šå¸¸è‡ªåŠ¨é‡Šæ”¾ï¼‰

```csharp
if (wakeLock) {
  await wakeLock.release(); // æ˜¾å¼é‡Šæ”¾
  wakeLock = null;
}
```

> é”ä¼šåœ¨ä»¥ä¸‹æƒ…å†µ**è‡ªåŠ¨é‡Šæ”¾**ï¼š
> 
> -   é¡µé¢è¿›å…¥åå°ï¼ˆ`visibilitychange`Â â†’Â `hidden`ï¼‰
> -   æµè§ˆå™¨æ ‡ç­¾é¡µå…³é—­
> -   ç”¨æˆ·æ‰‹åŠ¨é”å±
> -   é¡µé¢å¤±å»ç„¦ç‚¹ï¼ˆéƒ¨åˆ†æµè§ˆå™¨ï¼‰

___

### ğŸŒ æµè§ˆå™¨å…¼å®¹æ€§ï¼ˆæˆªè‡³ 2025 å¹´ï¼‰

|   æµè§ˆå™¨   |                æ”¯æŒæƒ…å†µ                |
|---------|------------------------------------|
| Chrome  |      âœ… 84+ï¼ˆAndroid & Desktopï¼‰      |
|  Edge   |               âœ… 84+                |
| Safari  |       âŒ ä¸æ”¯æŒï¼ˆiOS/macOS å‡æœªå®ç°ï¼‰        |
| Firefox | âŒ é»˜è®¤ç¦ç”¨ï¼ˆéœ€æ‰‹åŠ¨å¼€å¯Â `dom.wakelock.enabled`ï¼‰ |

> **ç§»åŠ¨ç«¯ Chromeï¼ˆAndroidï¼‰æ”¯æŒæœ€å¥½**ï¼ŒiOS Safari **å®Œå…¨ä¸æ”¯æŒ**ã€‚

å¯é€šè¿‡ [caniuse.com/wake-lock](https://link.juejin.cn/?target=) æŸ¥çœ‹æœ€æ–°çŠ¶æ€ã€‚

___

### ğŸ›¡ï¸ å®‰å…¨ä¸æƒé™è¦æ±‚

-   **å¿…é¡»åœ¨ HTTPS ä¸‹ä½¿ç”¨**ï¼ˆlocalhost é™¤å¤–ï¼‰
-   **å¿…é¡»ç”±ç”¨æˆ·æ‰‹åŠ¿è§¦å‘**ï¼ˆå¦‚ç‚¹å‡»ã€è§¦æ‘¸ï¼‰
-   **ä»…åœ¨é¡µé¢å¯è§æ—¶æœ‰æ•ˆ**ï¼ˆé¡µé¢åˆ‡åˆ°åå°ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼‰
-   **ä¸ä¼šç»•è¿‡ç³»ç»Ÿé”å±å¯†ç **ï¼Œä»…é˜²æ­¢å±å¹•å˜æš—/ä¼‘çœ 

___

### ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯ç¤ºä¾‹

#### åœºæ™¯ï¼šè§†é¢‘æ’­æ”¾æ—¶ä¸é”å±

```javascript
const video = document.querySelector('video');

video.addEventListener('play', async () => {
  if ('wakeLock' in navigator) {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
    } catch (err) {
      console.warn('æ— æ³•ä¿æŒå±å¹•å¸¸äº®:', err);
    }
  }
});

video.addEventListener('pause', () => {
  if (wakeLock) wakeLock.release();
});
```

#### åœºæ™¯ï¼šç»“åˆ Page Visibility è‡ªåŠ¨ç®¡ç†

```javascript
document.addEventListener('visibilitychange', () => {
  if (document.hidden && wakeLock) {
    wakeLock.release(); // é¡µé¢éšè—æ—¶ä¸»åŠ¨é‡Šæ”¾
  }
});
```

___

### ğŸ”„ é™çº§æ–¹æ¡ˆï¼ˆFallbackï¼‰

åœ¨ä¸æ”¯æŒ Wake Lock çš„ç¯å¢ƒï¼ˆå¦‚ iOSï¼‰ï¼š

-   æç¤ºç”¨æˆ·â€œè¯·æ‰‹åŠ¨å…³é—­è‡ªåŠ¨é”å±â€
-   ä½¿ç”¨å…¨å± APIï¼ˆ`requestFullscreen()`ï¼‰æœ‰æ—¶å¯å»¶é•¿å±å¹•æ´»è·ƒæ—¶é—´ï¼ˆéå¯é ï¼‰
-   å¯¹äºè§†é¢‘ï¼Œå¯å°è¯•ä½¿ç”¨Â `<video playsinline webkit-playsinline>`Â ç­‰å±æ€§ä¼˜åŒ–ä½“éªŒ

___

### ğŸ“Œ æ³¨æ„äº‹é¡¹

-   **ä¸è¦æ»¥ç”¨**ï¼šé•¿æ—¶é—´ä¿æŒå”¤é†’ä¼šæ˜¾è‘—å¢åŠ è€—ç”µã€‚
-   **å§‹ç»ˆæä¾›å…³é—­é€‰é¡¹**ï¼šè®©ç”¨æˆ·èƒ½æ‰‹åŠ¨ç¦ç”¨â€œä¿æŒå”¤é†’â€ã€‚
-   **æµ‹è¯•çœŸå®è®¾å¤‡**ï¼šæ¨¡æ‹Ÿå™¨è¡Œä¸ºå¯èƒ½ä¸çœŸæœºä¸åŒã€‚

___

### ğŸ” æ£€æµ‹æ˜¯å¦æ”¯æŒ

```csharp
if ('wakeLock' in navigator) {
  // æ”¯æŒ Wake Lock API
}
```

## 6\. Broadcast Channel

`BroadcastChannel` æ˜¯ä¸€ä¸ªç°ä»£ Web APIï¼Œå…è®¸**åŒæºï¼ˆsame-originï¼‰çš„ä¸åŒæµè§ˆå™¨ä¸Šä¸‹æ–‡**ï¼ˆå¦‚å¤šä¸ªæ ‡ç­¾é¡µã€iframeã€Web Workerï¼‰ä¹‹é—´è¿›è¡Œ**ç®€å•ã€é«˜æ•ˆçš„è·¨æ–‡æ¡£é€šä¿¡**ã€‚ å®ƒç±»ä¼¼äºâ€œå‘å¸ƒ-è®¢é˜…â€æ¨¡å¼ï¼šä¸€ä¸ªä¸Šä¸‹æ–‡å‘é€æ¶ˆæ¯ï¼Œæ‰€æœ‰ç›‘å¬åŒä¸€é¢‘é“çš„å…¶ä»–ä¸Šä¸‹æ–‡éƒ½èƒ½æ”¶åˆ°ã€‚

___

### ğŸ§© åŸºæœ¬ç”¨æ³•

#### 1\. åˆ›å»ºé¢‘é“å¹¶ç›‘å¬æ¶ˆæ¯

```javascript
// æ‰€æœ‰é¡µé¢/worker ä½¿ç”¨ç›¸åŒçš„é¢‘é“å
const channel = new BroadcastChannel('my-app-channel');

// ç›‘å¬æ¥è‡ªå…¶ä»–ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯
channel.addEventListener('message', (event) => {
  console.log('æ”¶åˆ°æ¶ˆæ¯:', event.data);
});

// æˆ–ä½¿ç”¨ onmessage
// channel.onmessage = (event) => { ... };
```

#### 2\. å‘é€æ¶ˆæ¯

```javascript
// ä»»æ„åŒæºé¡µé¢æˆ– worker ä¸­
channel.postMessage({ type: 'USER_LOGIN', userId: 123 });
```

#### 3\. å…³é—­é¢‘é“ï¼ˆå¯é€‰ï¼Œæ¨èåœ¨é¡µé¢å¸è½½æ—¶è°ƒç”¨ï¼‰

```javascript
window.addEventListener('beforeunload', () => {
  channel.close(); // é‡Šæ”¾èµ„æº
});
```

> âœ… **è‡ªåŠ¨å¹¿æ’­**ï¼šæ¶ˆæ¯ä¼šå‘é€ç»™**æ‰€æœ‰**ç›‘å¬ `'my-app-channel'` çš„åŒæºä¸Šä¸‹æ–‡ï¼ˆåŒ…æ‹¬å‘é€è€…è‡ªå·±ï¼Œé™¤éä½ è¿‡æ»¤ï¼‰ã€‚

___

### ğŸ” å®‰å…¨é™åˆ¶

-   **åŒæºç­–ç•¥**ï¼šåªæœ‰åè®® + åŸŸå + ç«¯å£å®Œå…¨ç›¸åŒçš„é¡µé¢æ‰èƒ½é€šä¿¡ã€‚
    
    -   `https://example.com/page1`Â å’ŒÂ `https://example.com/page2`Â âœ…
    -   `https://example.com`Â å’ŒÂ `https://sub.example.com`Â âŒ
    -   `http://localhost:3000`Â å’ŒÂ `http://localhost:8080`Â âŒ
-   **ä¸æ”¯æŒè·¨åŸŸ**ï¼šä¸èƒ½ç”¨äºè·¨åŸŸ iframe é€šä¿¡ï¼ˆæ­¤æ—¶åº”è€ƒè™‘ `postMessage` + `origin` éªŒè¯ï¼‰ã€‚
    

___

### âœ… å…¸å‹åº”ç”¨åœºæ™¯

#### 1.Â **ç”¨æˆ·ç™»å½•/ç™»å‡ºåŒæ­¥**

å½“ç”¨æˆ·åœ¨ä¸€ä¸ªæ ‡ç­¾é¡µç™»å½•ï¼Œå…¶ä»–æ ‡ç­¾é¡µè‡ªåŠ¨æ›´æ–°çŠ¶æ€ï¼š

```javascript
// ç™»å½•é¡µ
channel.postMessage({ type: 'AUTH_CHANGED', user: { id: 1, name: 'Alice' } });

// å…¶ä»–é¡µé¢
channel.onmessage = (e) => {
  if (e.data.type === 'AUTH_CHANGED') {
    if (e.data.user) {
      updateUI(e.data.user); // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
    } else {
      logoutAllTabs(); // ç”¨æˆ·ç™»å‡º
    }
  }
};
```

#### 2.Â **å¤šæ ‡ç­¾é¡µçŠ¶æ€åŒæ­¥**

-   è´­ç‰©è½¦å˜æ›´
-   ä¸»é¢˜åˆ‡æ¢ï¼ˆæ·±è‰²/æµ…è‰²æ¨¡å¼ï¼‰
-   è¯­è¨€åˆ‡æ¢

#### 3.Â **é€šçŸ¥å…¶ä»–æ ‡ç­¾é¡µåˆ·æ–°æ•°æ®**

ä¾‹å¦‚åå°ç®¡ç†é¡µæ›´æ–°åï¼Œé€šçŸ¥å‰å°é¡µé¢é‡æ–°æ‹‰å–é…ç½®ã€‚

#### 4.Â **ä¸ Web Worker é€šä¿¡**

ä¸»çº¿ç¨‹å’Œå¤šä¸ª worker å¯é€šè¿‡ BroadcastChannel å¹¿æ’­æ¶ˆæ¯ã€‚

___

### ğŸŒ æµè§ˆå™¨å…¼å®¹æ€§ï¼ˆæˆªè‡³ 2025 å¹´ï¼‰

|     æµè§ˆå™¨     |                 æ”¯æŒæƒ…å†µ                 |
|-------------|--------------------------------------|
|   Chrome    |                âœ… 54+                 |
|    Edge     |                âœ… 79+                 |
|   Firefox   |                âœ… 38+                 |
|   Safari    | âœ… 15.4+ï¼ˆiOS 15.4+ / macOS Monterey+ï¼‰ |
| iOS WebView |               âœ… 15.4+                |

> âš ï¸ **Safari åœ¨ 15.4 ä¹‹å‰å®Œå…¨ä¸æ”¯æŒ**ï¼Œå¦‚éœ€å…¼å®¹æ—§ç‰ˆ iOSï¼Œéœ€ä½¿ç”¨ `localStorage` + `storage` äº‹ä»¶ä½œä¸º fallbackã€‚

___

### ğŸ”„ é™çº§æ–¹æ¡ˆï¼ˆFallback for older browsersï¼‰

åˆ©ç”¨ `localStorage` çš„ `storage` äº‹ä»¶å®ç°ç±»ä¼¼å¹¿æ’­ï¼š

```javascript
// å‘é€æ¶ˆæ¯ï¼ˆfallbackï¼‰
function broadcastFallback(message) {
  localStorage.setItem('broadcast-msg', JSON.stringify({
    ...message,
    timestamp: Date.now()
  }));
}

// æ¥æ”¶æ¶ˆæ¯ï¼ˆå…¶ä»–æ ‡ç­¾é¡µä¼šè§¦å‘ storage äº‹ä»¶ï¼‰
window.addEventListener('storage', (e) => {
  if (e.key === 'broadcast-msg') {
    const message = JSON.parse(e.newValue);
    console.log('Fallback æ”¶åˆ°:', message);
  }
});
```

> ç¼ºç‚¹ï¼šåªèƒ½ä¼ é€’å­—ç¬¦ä¸²ï¼Œä¸” `storage` äº‹ä»¶**ä¸ä¼šåœ¨å½“å‰æ ‡ç­¾é¡µè§¦å‘**ï¼ˆæ­£å¥½é¿å…è‡ªå·±æ”¶åˆ°è‡ªå·±å‘çš„æ¶ˆæ¯ï¼‰ã€‚

___

### ğŸ†š ä¸å…¶ä»–é€šä¿¡æ–¹å¼å¯¹æ¯”

|           æ–¹å¼           |    é€‚ç”¨åœºæ™¯    |      è·¨åŸŸ       |       å¤šæ ‡ç­¾        | Worker  |
|------------------------|------------|---------------|------------------|---------|
|    `BroadcastChannel`    |  åŒæºå¤šä¸Šä¸‹æ–‡å¹¿æ’­  |       âŒ       |        âœ…         |    âœ…    |
|   `window.postMessage`   |  ç²¾ç¡®ç‚¹å¯¹ç‚¹é€šä¿¡   | âœ…ï¼ˆéœ€éªŒè¯ originï¼‰ | âœ…ï¼ˆéœ€æŒæœ‰ window å¼•ç”¨ï¼‰ |    âœ…    |
|      `SharedWorker`      |  å¤šé¡µé¢å…±äº«é€»è¾‘   |       âŒ       |        âœ…         | âœ…ï¼ˆä½œä¸ºä¸­ä»‹ï¼‰ |
| `localStorage + storage` | ç®€å•å¹¿æ’­ï¼ˆæ—§æµè§ˆå™¨ï¼‰ |       âŒ       |        âœ…         |    âŒ    |

___

### ğŸ’¡ å°æŠ€å·§

-   **é¿å…æ— é™å¾ªç¯**ï¼šå¦‚æœå¤šä¸ªé¡µé¢éƒ½å“åº”æ¶ˆæ¯å¹¶å†æ¬¡å¹¿æ’­ï¼Œå¯èƒ½å½¢æˆå¾ªç¯ã€‚å»ºè®®ä½¿ç”¨Â `type`Â å­—æ®µåŒºåˆ†æ¶ˆæ¯æ¥æºæˆ–æ·»åŠ é˜²é‡æœºåˆ¶ã€‚
-   **ç»“æ„åŒ–å…‹éš†**ï¼š`postMessage`Â æ”¯æŒä¼ è¾“Â `ArrayBuffer`ã€`Blob`ã€`Map`Â ç­‰ï¼ˆéµå¾ª[ç»“æ„åŒ–å…‹éš†ç®—æ³•](https://link.juejin.cn/?target=)ï¼‰ï¼Œä¸åªæ˜¯ JSONã€‚

___

### ğŸ“¦ åœ¨æ¡†æ¶ä¸­ä½¿ç”¨ï¼ˆReact ç¤ºä¾‹ï¼‰

```javascript
import { useEffect } from 'react';

function useBroadcastChannel(channelName, onMessage) {
  useEffect(() => {
    const channel = new BroadcastChannel(channelName);
    channel.onmessage = onMessage;

    return () => {
      channel.close();
    };
  }, [channelName, onMessage]);
}

// ä½¿ç”¨
function App() {
  useBroadcastChannel('theme-channel', (e) => {
    if (e.data.type === 'THEME_CHANGE') {
      document.body.className = e.data.theme;
    }
  });

  const changeTheme = (theme) => {
    new BroadcastChannel('theme-channel').postMessage({
      type: 'THEME_CHANGE',
      theme
    });
  };

  return <button onClick={() => changeTheme('dark')}>åˆ‡æ¢æ·±è‰²</button>;
}
```

**`BroadcastChannelå’Œ Vuex / Redux`**

#### ğŸ” æ ¸å¿ƒåŒºåˆ«

|  ç‰¹æ€§   |         `BroadcastChannel`         | Vuex / Redux / Zustand ç­‰ |
|-------|----------------------------------|--------------------------|
| **ä½œç”¨èŒƒå›´**  | **è·¨æµè§ˆå™¨ä¸Šä¸‹æ–‡**ï¼ˆå¤šä¸ªæ ‡ç­¾é¡µã€iframeã€Web Workerï¼‰ |     **å•ä¸ªé¡µé¢/åº”ç”¨å†…éƒ¨**ï¼ˆç»„ä»¶ä¹‹é—´ï¼‰      |
| **é€šä¿¡æ–¹å¼**  |        è·¨æ–‡æ¡£å¹¿æ’­ï¼ˆç±»ä¼¼â€œå…¨å±€äº‹ä»¶æ€»çº¿â€ï¼‰         |     å•å‘æ•°æ®æµ + å“åº”å¼çŠ¶æ€ç®¡ç†      |
| **æ•°æ®å­˜å‚¨**  |          âŒ ä¸å­˜å‚¨çŠ¶æ€ï¼Œåªä¼ é€’æ¶ˆæ¯           |     âœ… é›†ä¸­å¼å­˜å‚¨çŠ¶æ€ï¼ˆstoreï¼‰     |
| **å“åº”å¼æ›´æ–°** |         âŒ éœ€æ‰‹åŠ¨ç›‘å¬æ¶ˆæ¯å¹¶æ›´æ–° UI          |     âœ… çŠ¶æ€å˜åŒ–è‡ªåŠ¨è§¦å‘ç»„ä»¶é‡æ¸²æŸ“      |
| **åŒæºé™åˆ¶**  |             âœ… ä»…é™åŒæºé¡µé¢             |        æ— ï¼ˆä»…é™å½“å‰é¡µé¢ï¼‰         |
| **å…¸å‹ç”¨é€”**  |       å¤šæ ‡ç­¾é¡µç™»å½•åŒæ­¥ã€è·¨ Worker é€šä¿¡       |     ç»„ä»¶é—´çŠ¶æ€å…±äº«ã€å¤æ‚çŠ¶æ€é€»è¾‘ç®¡ç†     |

___

#### ğŸ§© ä¸¾ä¸ªä¾‹å­è¯´æ˜å·®å¼‚

##### åœºæ™¯ï¼šç”¨æˆ·ç™»å½•åï¼Œæ‰€æœ‰æ‰“å¼€çš„æ ‡ç­¾é¡µéƒ½è¦æ˜¾ç¤ºç”¨æˆ·å

-   **ç”¨ `BroadcastChannel`**ï¼š
    
    -   æ ‡ç­¾é¡µ A ç™»å½• â†’ é€šè¿‡Â `channel.postMessage({ type: 'LOGIN', user })`Â å¹¿æ’­ã€‚
    -   æ ‡ç­¾é¡µ Bã€Cï¼ˆå³ä½¿æ²¡ç”¨ Vue/Reactï¼‰ç›‘å¬åˆ°æ¶ˆæ¯ â†’Â **å„è‡ªæ›´æ–°è‡ªå·±çš„ UI**ã€‚
    -   æ¯ä¸ªé¡µé¢**ç‹¬ç«‹ç»´æŠ¤è‡ªå·±çš„çŠ¶æ€**ï¼Œåªæ˜¯é€šè¿‡æ¶ˆæ¯â€œåŒæ­¥â€äº†ç™»å½•äº‹ä»¶ã€‚
-   **ç”¨ Vuex**ï¼š
    
    -   åªåœ¨**å½“å‰æ ‡ç­¾é¡µå†…**ï¼Œå¤šä¸ª Vue ç»„ä»¶å…±äº«Â `store.state.user`ã€‚
    -   æ ‡ç­¾é¡µ A çš„ VuexÂ **æ— æ³•ç›´æ¥å½±å“**æ ‡ç­¾é¡µ B çš„ Vuexã€‚
    -   å¦‚æœä½ æ‰“å¼€ä¸¤ä¸ªæ ‡ç­¾é¡µï¼Œå®ƒä»¬æœ‰**ä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„ Vuex å®ä¾‹**ã€‚

> âœ… æ‰€ä»¥ï¼š**Vuex ç®¡â€œé¡µé¢å†…â€ï¼ŒBroadcastChannel ç®¡â€œé¡µé¢é—´â€** ã€‚

___

#### ğŸ¤ å®ƒä»¬å¯ä»¥ç»“åˆä½¿ç”¨ï¼

å®é™…é¡¹ç›®ä¸­ï¼Œ**ä¸¤è€…å¸¸é…åˆä½¿ç”¨**ï¼š

```javascript
// åœ¨ Vuex çš„ action ä¸­ç›‘å¬ BroadcastChannel
const channel = new BroadcastChannel('auth-channel');

const store = new Vuex.Store({
  state: { user: null },
  mutations: {
    SET_USER(state, user) {
      state.user = user;
    }
  },
  actions: {
    login({ commit }, user) {
      commit('SET_USER', user);
      // ç™»å½•åå¹¿æ’­ç»™å…¶ä»–æ ‡ç­¾é¡µ
      channel.postMessage({ type: 'LOGIN', user });
    }
  }
});

// ç›‘å¬å…¶ä»–æ ‡ç­¾é¡µçš„ç™»å½•/ç™»å‡º
channel.onmessage = (e) => {
  if (e.data.type === 'LOGIN') {
    store.commit('SET_USER', e.data.user); // æ›´æ–°å½“å‰é¡µçŠ¶æ€
  } else if (e.data.type === 'LOGOUT') {
    store.commit('SET_USER', null);
  }
};
```

è¿™æ ·ï¼š

-   é¡µé¢å†…ï¼šVuex ç®¡ç†çŠ¶æ€ï¼Œç»„ä»¶è‡ªåŠ¨å“åº”ã€‚
-   é¡µé¢é—´ï¼šBroadcastChannel åŒæ­¥å…³é”®äº‹ä»¶ã€‚

___

#### â“é‚£æœ‰æ²¡æœ‰â€œè·¨æ ‡ç­¾é¡µçš„ Vuexâ€ï¼Ÿ

æœ‰ï¼ç¤¾åŒºæœ‰ä¸€äº›åº“å°è¯•ç»“åˆä¸¤è€…ï¼Œä¾‹å¦‚ï¼š

-   [`vuex-shared-mutations`](https://link.juejin.cn/?target=)ï¼šé€šè¿‡Â `localStorage`Â æˆ–Â `BroadcastChannel`Â åŒæ­¥ Vuex çš„ mutationsã€‚
-   è‡ªå®šä¹‰æ–¹æ¡ˆï¼šç›‘å¬Â `storage`Â äº‹ä»¶æˆ–Â `BroadcastChannel`ï¼Œè§¦å‘æœ¬åœ° store æ›´æ–°ã€‚

ä½†æ ¸å¿ƒæ€æƒ³ä¸å˜ï¼š**è·¨æ ‡ç­¾é¡µé€šä¿¡é  BroadcastChannelï¼ˆæˆ– storageï¼‰ï¼ŒçŠ¶æ€ç®¡ç†é  Vuex**ã€‚

___

#### âœ… æ€»ç»“

|      ä½ æƒ³åšâ€¦â€¦       |                     è¯¥ç”¨â€¦â€¦                      |
|------------------|-----------------------------------------------|
|  ç»„ä»¶ä¹‹é—´å…±äº«çŠ¶æ€ã€è§¦å‘æ›´æ–°   |       **Vuex / Redux / Context / Zustand**        |
|  å¤šä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µåŒæ­¥ç™»å½•çŠ¶æ€  | **BroadcastChannel**ï¼ˆæˆ–Â `localStorage`Â +Â `storage`Â äº‹ä»¶ï¼‰ |
| è®© Vuex çŠ¶æ€åœ¨å¤šæ ‡ç­¾é¡µåŒæ­¥ |          **BroadcastChannel + Vuex ç»“åˆ**           |

## 7\. PerformanceObserver

`PerformanceObserver` æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ Web APIï¼Œç”¨äº**å¼‚æ­¥ç›‘å¬æ€§èƒ½ç›¸å…³çš„äº‹ä»¶å’ŒæŒ‡æ ‡**ï¼Œè€Œæ— éœ€è½®è¯¢ `performance.getEntries()`ã€‚å®ƒæ˜¯ç°ä»£ Web æ€§èƒ½ç›‘æ§ï¼ˆå¦‚ Core Web Vitalsï¼‰çš„æ ¸å¿ƒå·¥å…·ã€‚

___

### ğŸ¯ æ ¸å¿ƒä½œç”¨

ç›‘å¬æµè§ˆå™¨è‡ªåŠ¨è®°å½•çš„ **Performance Timelineï¼ˆæ€§èƒ½æ—¶é—´çº¿ï¼‰** ä¸­çš„æ–°æ¡ç›®ï¼Œä¾‹å¦‚ï¼š

-   èµ„æºåŠ è½½ï¼ˆ`resource`ï¼‰
-   å¯¼èˆª timingï¼ˆ`navigation`ï¼‰
-   é•¿ä»»åŠ¡ï¼ˆ`longtask`ï¼‰
-   å…ƒç´ æ›å…‰ï¼ˆ`element`ï¼Œå®éªŒæ€§ï¼‰
-   **æœ€é‡è¦ï¼š** Â **CLSã€LCPã€FCPã€INP ç­‰ Web Vitals æŒ‡æ ‡**

___

### ğŸ§© åŸºæœ¬ç”¨æ³•

```javascript
const observer = new PerformanceObserver((list) => {
  for (const entry of list.getEntries()) {
    console.log(entry.name, entry.entryType, entry.startTime, entry.duration);
  }
});

// å¼€å§‹ç›‘å¬ç‰¹å®šç±»å‹çš„æ€§èƒ½æ¡ç›®
observer.observe({ entryTypes: ['resource', 'navigation', 'paint'] });
```

> âš ï¸ å¿…é¡»æŒ‡å®š `entryTypes`ï¼ˆæˆ– `type`ï¼‰ï¼Œå¦åˆ™ä¸ä¼šè§¦å‘å›è°ƒã€‚

___

### ğŸ” å¸¸è§Â `entryTypes`Â åŠç”¨é€”

|              `entryType`              |                 è¯´æ˜                 |       å…¸å‹ç”¨é€”       |
|-------------------------------------|------------------------------------|------------------|
|            `'navigation'`             | é¡µé¢å¯¼èˆªæ€§èƒ½ï¼ˆå¦‚ DNSã€TCPã€DOMContentLoadedï¼‰ |     åˆ†æé¦–å±åŠ è½½ç“¶é¢ˆ     |
|             `'resource'`              |    æ‰€æœ‰èµ„æºåŠ è½½ï¼ˆJSã€CSSã€å›¾ç‰‡ã€XHRã€fetchï¼‰     |   ç›‘æ§ç¬¬ä¸‰æ–¹èµ„æºã€æ…¢è¯·æ±‚    |
|               `'paint'`               |        é¦–æ¬¡ç»˜åˆ¶ï¼ˆFPï¼‰ã€é¦–æ¬¡å†…å®¹ç»˜åˆ¶ï¼ˆFCPï¼‰        |     è¡¡é‡è§†è§‰åŠ è½½é€Ÿåº¦     |
|             `'longtask'`              |           è¶…è¿‡ 50ms çš„ä¸»çº¿ç¨‹ä»»åŠ¡           |  è¯†åˆ«å¡é¡¿ã€å½±å“äº¤äº’å“åº”çš„åŸå›   |
|  `'largest-contentful-paint'`Â (LCP)   |             æœ€å¤§å†…å®¹å…ƒç´ æ¸²æŸ“æ—¶é—´             | æ ¸å¿ƒ Web Vitals æŒ‡æ ‡ |
|        `'layout-shift'`Â (CLS)         |               ç´¯ç§¯å¸ƒå±€åç§»               |     æ£€æµ‹é¡µé¢â€œæŠ–åŠ¨â€     |
| `'first-input'`Â (FID) /Â `'event'`Â (INP) |          é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ / äº¤äº’åˆ°ä¸‹æ¬¡ç»˜åˆ¶          |     è¡¡é‡äº¤äº’å“åº”æ€§      |

> âœ… **LCPã€CLSã€INP ç­‰ç°ä»£æŒ‡æ ‡å¿…é¡»é€šè¿‡ `PerformanceObserver` è·å–**ï¼Œæ— æ³•é€šè¿‡ `getEntries()` é™æ€è¯»å–ã€‚

___

### âœ… å®æˆ˜ç¤ºä¾‹

#### 1\. ç›‘å¬ LCPï¼ˆæœ€å¤§å†…å®¹ç»˜åˆ¶ï¼‰

```javascript
let lcpReported = false;

new PerformanceObserver((entryList) => {
  const lcpEntry = entryList.getEntries().at(-1); // å–æœ€åä¸€ä¸ªï¼ˆæœ€å‡†ç¡®ï¼‰
  if (!lcpReported) {
    console.log('LCP:', lcpEntry.startTime); // å•ä½ï¼šæ¯«ç§’
    // ä¸ŠæŠ¥åˆ°åˆ†æå¹³å°
    sendToAnalytics({ metric: 'LCP', value: lcpEntry.startTime });
    lcpReported = true;
  }
}).observe({ type: 'largest-contentful-paint', buffered: true });
```

> `buffered: true` è¡¨ç¤ºè·å–**å·²å‘ç”Ÿä½†æœªè¢«è§‚å¯Ÿåˆ°çš„å†å²æ¡ç›®**ï¼ˆå¯¹ LCP/CLS å¿…é¡»åŠ ï¼ï¼‰ã€‚

___

#### 2\. ç›‘å¬ CLSï¼ˆç´¯ç§¯å¸ƒå±€åç§»ï¼‰

```javascript
let clsValue = 0;

new PerformanceObserver((entryList) => {
  for (const entry of entryList.getEntries()) {
    if (!entry.hadRecentInput) { // å¿½ç•¥ç”¨æˆ·äº¤äº’åçš„åç§»
      clsValue += entry.value;
    }
  }
  console.log('å½“å‰ CLS:', clsValue);
}).observe({ type: 'layout-shift', buffered: true });
```

___

#### 3\. ç›‘æ§æ…¢èµ„æºåŠ è½½

```javascript
new PerformanceObserver((list) => {
  for (const resource of list.getEntries()) {
    if (resource.duration > 2000) {
      console.warn('æ…¢èµ„æº:', resource.name, resource.duration + 'ms');
      // ä¸ŠæŠ¥æ€§èƒ½é—®é¢˜
    }
  }
}).observe({ entryTypes: ['resource'] });
```

___

#### 4\. æ•è·é•¿ä»»åŠ¡ï¼ˆå¡é¡¿åŸå› ï¼‰

```javascript
new PerformanceObserver((list) => {
  for (const task of list.getEntries()) {
    if (task.duration > 100) {
      console.log('é•¿ä»»åŠ¡:', task.duration + 'ms', task.attribution);
    }
  }
}).observe({ entryTypes: ['longtask'] });
```

> éœ€è¦å…ˆæ³¨å†Œé•¿ä»»åŠ¡æ”¯æŒï¼ˆéƒ¨åˆ†æµè§ˆå™¨éœ€ polyfillï¼‰ï¼š
> 
> ```less
> if (PerformanceObserver.supportedEntryTypes.includes('longtask')) {
>   // å¯ç”¨è§‚å¯Ÿ
> }
> ```

___

### ğŸŒ æµè§ˆå™¨å…¼å®¹æ€§

-   âœ… Chrome / Edgeï¼šå…¨é¢æ”¯æŒï¼ˆåŒ…æ‹¬ Web Vitalsï¼‰
-   âœ… Firefoxï¼šæ”¯æŒåŸºç¡€ç±»å‹ï¼ˆ`resource`,Â `navigation`ï¼‰ï¼ŒWeb Vitals æ”¯æŒè¾ƒå¼±
-   âœ… Safari 15+ï¼šæ”¯æŒ LCPã€CLSã€FCP ç­‰æ ¸å¿ƒæŒ‡æ ‡
-   âŒ IEï¼šä¸æ”¯æŒ

> æ¨èä½¿ç”¨ [Google çš„ `web-vitals` åº“](https://link.juejin.cn/?target=) è·¨æµè§ˆå™¨é‡‡é›† Core Web Vitalsã€‚

___

### ğŸ“¦ ä¸Â `performance.getEntries()`Â å¯¹æ¯”

|            æ–¹å¼            |             ä¼˜ç‚¹             |              ç¼ºç‚¹              |
|--------------------------|----------------------------|------------------------------|
|   `PerformanceObserver`    | å¼‚æ­¥ã€å®æ—¶ã€æ”¯æŒ Web Vitalsã€ä¸é˜»å¡ä¸»çº¿ç¨‹ |           éœ€è¦æå‰æ³¨å†Œç›‘å¬           |
| `performance.getEntries()` |         ç®€å•ç›´æ¥ã€å¯æŸ¥è¯¢å†å²         | æ— æ³•è·å–åŠ¨æ€æŒ‡æ ‡ï¼ˆå¦‚ LCP åœ¨å‘ç”Ÿæ—¶æ‰èƒ½ç¡®å®šï¼‰ã€éœ€è½®è¯¢ |

> âœ… **ç°ä»£æ€§èƒ½ç›‘æ§åº”ä¼˜å…ˆä½¿ç”¨ `PerformanceObserver`**ã€‚

___

### ğŸš€ æœ€ä½³å®è·µ

1.  **å°½æ—©æ³¨å†Œ**ï¼šåœ¨Â `<head>`Â ä¸­æˆ–é¡µé¢é¡¶éƒ¨åˆå§‹åŒ–ï¼Œé¿å…æ¼æ‰æ—©æœŸæŒ‡æ ‡ã€‚
2.  **ä½¿ç”¨Â `buffered: true`**ï¼šç¡®ä¿æ•è· FCPã€LCPã€CLS ç­‰å¯èƒ½åœ¨ç›‘å¬å‰å·²å‘ç”Ÿçš„æŒ‡æ ‡ã€‚
3.  **é¿å…å†…å­˜æ³„æ¼**ï¼šé€šå¸¸ä¸éœ€è¦Â `disconnect()`ï¼Œå› ä¸ºæ€§èƒ½æ¡ç›®æ˜¯ä¸€æ¬¡æ€§çš„ã€‚
4.  **ç»“åˆ RUMï¼ˆçœŸå®ç”¨æˆ·ç›‘æ§ï¼‰** ï¼šå°†æ•°æ®ä¸ŠæŠ¥åˆ°åˆ†æå¹³å°ï¼ˆå¦‚ GA4ã€Sentryã€è‡ªå»ºæœåŠ¡ï¼‰ã€‚

___

### ğŸ› ï¸ å·¥å…·æ¨è

-   [`web-vitals`Â npm åŒ…](https://link.juejin.cn/?target=)ï¼šGoogle å®˜æ–¹å°è£…ï¼Œä¸€è¡Œä»£ç è·å– Web Vitalsã€‚

```javascript
import { getLCP, getCLS, getFCP } from 'web-vitals';
getLCP(console.log);
```

**Reactï¼ˆä½¿ç”¨ Hookï¼‰** å’Œ **Vue 3ï¼ˆä½¿ç”¨ Composition APIï¼‰**

### âœ… å…±åŒå‰æ

æˆ‘ä»¬ä½¿ç”¨ Google å®˜æ–¹çš„ [`web-vitals`](https://link.juejin.cn/?target=) åº“ï¼Œå®ƒå·²å°è£…å¥½ `PerformanceObserver` çš„å…¼å®¹é€»è¾‘ã€‚

```
npm install web-vitals
```

___

### ğŸŸ¦ React ç‰ˆæœ¬ï¼š`useWebVitals`

```typescript
// hooks/useWebVitals.ts
import { useEffect } from 'react';
import { getCLS, getFCP, getLCP, getFID, getINP } from 'web-vitals';

type WebVitalsMetric = {
  id: string;
  name: string;
  value: number;
  delta: number;
  entries: PerformanceEntry[];
  attribution: Record<string, unknown>;
};

type WebVitalsOptions = {
  onReport?: (metric: WebVitalsMetric) => void;
  reportAll?: boolean; // æ˜¯å¦ä¸ŠæŠ¥æ‰€æœ‰æŒ‡æ ‡ï¼ˆé»˜è®¤åªä¸ŠæŠ¥ä¸€æ¬¡ï¼‰
};

export const useWebVitals = ({
  onReport,
  reportAll = false
}: WebVitalsOptions = {}) => {
  useEffect(() => {
    // å®šä¹‰ä¸ŠæŠ¥å‡½æ•°
    const report = (metric: WebVitalsMetric) => {
      onReport?.(metric);
      if (process.env.NODE_ENV === 'development') {
        console.log('Web Vitals:', metric);
      }
    };

    // å¯åŠ¨ç›‘å¬ï¼ˆWeb Vitals å†…éƒ¨ä½¿ç”¨ PerformanceObserverï¼‰
    getCLS(report, reportAll);
    getFCP(report, reportAll);
    getLCP(report, reportAll);
    getFID(report); // FID åªè§¦å‘ä¸€æ¬¡
    getINP(report, reportAll); // INP æ›¿ä»£ FIDï¼ˆæœªæ¥æ ‡å‡†ï¼‰

    // æ³¨æ„ï¼šweb-vitals çš„æŒ‡æ ‡æ˜¯è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸçš„ï¼Œæ— éœ€ cleanup
  }, [onReport, reportAll]);
};
```

#### ğŸ“Œ ä½¿ç”¨ç¤ºä¾‹

```javascript
// App.tsx
import { useWebVitals } from './hooks/useWebVitals';

function App() {
  useWebVitals({
    onReport: (metric) => {
      // ä¸ŠæŠ¥åˆ°åˆ†æå¹³å°ï¼ˆå¦‚ GA4ã€Sentryã€è‡ªå»º APIï¼‰
      fetch('/api/performance', {
        method: 'POST',
        body: JSON.stringify(metric),
        headers: { 'Content-Type': 'application/json' }
      });
    }
  });

  return <div>ä½ çš„åº”ç”¨</div>;
}
```

> âœ… **ä¼˜ç‚¹**ï¼šè‡ªåŠ¨å¤„ç†æµè§ˆå™¨å…¼å®¹æ€§ã€åªä¸ŠæŠ¥æœ‰æ•ˆæŒ‡æ ‡ã€æ”¯æŒå¼€å‘ç¯å¢ƒæ—¥å¿—ã€‚

___

### ğŸŸ© Vue 3 ç‰ˆæœ¬ï¼š`useWebVitals`

```typescript
// composables/useWebVitals.ts
import { onMounted } from 'vue';
import { getCLS, getFCP, getLCP, getFID, getINP } from 'web-vitals';

type WebVitalsMetric = {
  id: string;
  name: string;
  value: number;
  delta: number;
  entries: PerformanceEntry[];
  attribution: Record<string, unknown>;
};

export function useWebVitals(
  onReport?: (metric: WebVitalsMetric) => void,
  reportAll = false
) {
  onMounted(() => {
    const report = (metric: WebVitalsMetric) => {
      onReport?.(metric);
      if (import.meta.env.DEV) {
        console.log('Web Vitals:', metric);
      }
    };

    getCLS(report, reportAll);
    getFCP(report, reportAll);
    getLCP(report, reportAll);
    getFID(report);
    getINP(report, reportAll);
  });
}
```

#### ğŸ“Œ ä½¿ç”¨ç¤ºä¾‹

```vue
<!-- App.vue -->
<script setup>
import { useWebVitals } from './composables/useWebVitals';

useWebVitals((metric) => {
  fetch('/api/performance', {
    method: 'POST',
    body: JSON.stringify(metric),
    headers: { 'Content-Type': 'application/json' }
  });
});
</script>

<template>
  <div>ä½ çš„åº”ç”¨</div>
</template>
```

___

### ğŸ§© é«˜çº§ï¼šç›‘æ§æ…¢èµ„æºåŠ è½½ï¼ˆè‡ªå®šä¹‰ PerformanceObserverï¼‰

å¦‚æœä½ è¿˜æƒ³ç›‘æ§ JS/CSS/å›¾ç‰‡ç­‰èµ„æºåŠ è½½æ€§èƒ½ï¼Œå¯ä»¥é¢å¤–å°è£…ä¸€ä¸ª Hookï¼š

#### React:Â `useResourcePerformance`

```javascript
// hooks/useResourcePerformance.ts
import { useEffect } from 'react';

export const useResourcePerformance = (onSlowResource: (entry: PerformanceResourceTiming) => void) => {
  useEffect(() => {
    if (!PerformanceObserver.supportedEntryTypes.includes('resource')) return;

    const observer = new PerformanceObserver((list) => {
      for (const entry of list.getEntries() as PerformanceResourceTiming[]) {
        if (entry.duration > 2000) {
          onSlowResource(entry);
        }
      }
    });

    observer.observe({ entryTypes: ['resource'] });

    return () => {
      observer.disconnect();
    };
  }, [onSlowResource]);
};
```

Vue ç‰ˆæœ¬ç±»ä¼¼ï¼Œç”¨ `onMounted` + `onUnmounted` ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€‚

___

### ğŸ“Š ä¸ŠæŠ¥å»ºè®®

-   **LCPã€FCPã€CLS**ï¼šæ¯ä¸ªé¡µé¢ä¼šè¯ä¸ŠæŠ¥ä¸€æ¬¡ï¼ˆ`reportAll: false`ï¼‰ã€‚
-   **INP/FID**ï¼šç”¨æˆ·æ¯æ¬¡äº¤äº’å¯èƒ½è§¦å‘ï¼Œå¯é‡‡æ ·ä¸ŠæŠ¥ã€‚
-   **æ…¢èµ„æº**ï¼šå¯èšåˆåæ‰¹é‡ä¸ŠæŠ¥ï¼Œé¿å…é¢‘ç¹è¯·æ±‚ã€‚

___

### ğŸš€ éƒ¨ç½²æç¤º

-   åœ¨Â **ç”Ÿäº§ç¯å¢ƒ**Â ä½¿ç”¨ï¼Œå¼€å‘ç¯å¢ƒä»…ç”¨äºè°ƒè¯•ã€‚
-   é¿å…é˜»å¡ä¸»æ¸²æŸ“é€»è¾‘ï¼ˆ`web-vitals`Â æ˜¯å¼‚æ­¥éé˜»å¡çš„ï¼‰ã€‚
-   é…åˆÂ [Google Analytics 4 çš„ Web Vitals è‡ªåŠ¨é‡‡é›†](https://link.juejin.cn/?target=)Â æ›´çœäº‹ã€‚

## 8\. requestIdleCallback

`requestIdleCallback` æ˜¯ä¸€ä¸ªæµè§ˆå™¨æä¾›çš„ APIï¼Œç”¨äº**åœ¨æµè§ˆå™¨ä¸»çº¿ç¨‹ç©ºé—²æ—¶æ‰§è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡**ï¼Œé¿å…å½±å“å…³é”®æ“ä½œï¼ˆå¦‚ç”¨æˆ·è¾“å…¥ã€åŠ¨ç”»ã€å¸ƒå±€ç­‰ï¼‰ï¼Œä»è€Œæå‡é¡µé¢æµç•…æ€§å’Œå“åº”æ€§ã€‚

> ğŸ’¡ å®ƒæ˜¯å®ç°â€œ**åä½œå¼è°ƒåº¦ï¼ˆCooperative Schedulingï¼‰** â€çš„å…³é”®å·¥å…·ï¼ŒReact 16+ çš„ Fiber æ¶æ„å°±å—å…¶å¯å‘ï¼ˆå°½ç®¡ React æœ€ç»ˆæœªç›´æ¥ä½¿ç”¨å®ƒï¼‰ã€‚

___

### ğŸ§© åŸºæœ¬ç”¨æ³•

```javascript
function doLowPriorityWork(deadline) {
  // deadline.timeRemaining()ï¼šè¿”å›å½“å‰ç©ºé—²æ—¶æ®µè¿˜å‰©å¤šå°‘æ¯«ç§’ï¼ˆé€šå¸¸ < 50msï¼‰
  // deadline.didTimeoutï¼šæ˜¯å¦å› è¶…æ—¶è€Œå¼ºåˆ¶æ‰§è¡Œï¼ˆé…åˆ timeout ä½¿ç”¨ï¼‰

  while (deadline.timeRemaining() > 0 || deadline.didTimeout) {
    if (hasWork()) {
      performUnitOfWork();
    } else {
      break; // æ²¡æœ‰æ›´å¤šå·¥ä½œï¼Œé€€å‡º
    }
  }

  // å¦‚æœè¿˜æœ‰å‰©ä½™ä»»åŠ¡ï¼Œç»§ç»­è°ƒåº¦
  if (hasMoreWork()) {
    requestIdleCallback(doLowPriorityWork);
  }
}

// å¯åŠ¨ä»»åŠ¡
requestIdleCallback(doLowPriorityWork, { timeout: 2000 });
```

___

### âš™ï¸ å‚æ•°è¯´æ˜

#### 1\. å›è°ƒå‡½æ•°å‚æ•°ï¼š`deadline`

-   `deadline.timeRemaining()`ï¼šè¿”å›ä¸€ä¸ª**ä¼°ç®—å€¼**ï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰ï¼Œè¡¨ç¤ºå½“å‰å¸§å‰©ä½™çš„ç©ºé—²æ—¶é—´ï¼ˆé€šå¸¸ â‰¤ 50msï¼‰ã€‚
-   `deadline.didTimeout`ï¼šå¦‚æœè®¾ç½®äº†Â `timeout`Â ä¸”è¶…æ—¶ï¼Œåˆ™ä¸ºÂ `true`ï¼Œæ­¤æ—¶åº”å°½å¿«å®Œæˆä»»åŠ¡ã€‚

#### 2\. å¯é€‰é…ç½®å¯¹è±¡

```yaml
{
  timeout: 2000 // æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚è¶…æ—¶åå³ä½¿æ²¡æœ‰ç©ºé—²ä¹Ÿä¼šæ‰§è¡Œå›è°ƒã€‚
}
```

> âš ï¸ **`timeout` ä¼šé™ä½ä¼˜å…ˆçº§ä¼˜åŠ¿**ï¼Œä»…ç”¨äºâ€œæœ€ç»ˆå¿…é¡»æ‰§è¡Œâ€çš„å…œåº•åœºæ™¯ã€‚

___

### âœ… å…¸å‹åº”ç”¨åœºæ™¯

#### 1.Â **éå…³é”®æ•°æ®é¢„åŠ è½½**

```javascript
requestIdleCallback(() => {
  // é¢„åŠ è½½ä¸‹ä¸€é¡µæ•°æ®ã€å›¾ç‰‡ã€ä»£ç åˆ†å‰² chunk
  import('./NextPageComponent');
});
```

#### 2.Â **åŸ‹ç‚¹/æ—¥å¿—æ‰¹é‡ä¸ŠæŠ¥**

```csharp
let logs = [];

function sendLogs() {
  if (logs.length > 0) {
    navigator.sendBeacon('/log', JSON.stringify(logs));
    logs = [];
  }
}

function addLog(event) {
  logs.push(event);
  requestIdleCallback(sendLogs, { timeout: 5000 });
}
```

#### 3.Â **å¤§å‹åˆ—è¡¨è™šæ‹Ÿæ»šåŠ¨çš„ç¼“å­˜è®¡ç®—**

åœ¨ç”¨æˆ·åœæ­¢æ»šåŠ¨åï¼Œåˆ©ç”¨ç©ºé—²æ—¶é—´é¢„è®¡ç®—å¯è§†åŒºåŸŸå¤–çš„ item å°ºå¯¸ã€‚

#### 4.Â **åˆ†æç”¨æˆ·è¡Œä¸ºï¼ˆéå®æ—¶ï¼‰**

å¦‚ç»Ÿè®¡åœç•™æ—¶é•¿ã€ç‚¹å‡»çƒ­åŠ›å›¾èšåˆç­‰ã€‚

___

### ğŸŒ æµè§ˆå™¨å…¼å®¹æ€§ï¼ˆæˆªè‡³ 2025 å¹´ï¼‰

|          æµè§ˆå™¨          |      æ”¯æŒæƒ…å†µ      |
|-----------------------|----------------|
|        Chrome         |     âœ… 47+      |
|         Edge          |     âœ… 79+      |
|        Firefox        | âŒÂ **ä¸æ”¯æŒ**ï¼ˆå·²æ˜ç¡®æ‹’ç»å®ç°ï¼‰ |
|        Safari         |     âŒÂ **ä¸æ”¯æŒ**      |
| iOS / Android WebView |    âŒ åŸºæœ¬ä¸å¯ç”¨     |

> ğŸ”¥ **ç°å®ï¼šä»… Chrome/Edge æ”¯æŒï¼ŒFirefox å’Œ Safari æ°¸è¿œä¸ä¼šæ”¯æŒï¼**

å¯é€šè¿‡ [caniuse.com/requestidleâ€¦](https://link.juejin.cn/?target=) æŸ¥çœ‹ã€‚

___

### ğŸ”„ é™çº§æ–¹æ¡ˆï¼ˆPolyfill / æ›¿ä»£æ–¹æ¡ˆï¼‰

ç”±äºå…¼å®¹æ€§å·®ï¼Œ**ç”Ÿäº§ç¯å¢ƒå¿…é¡»æä¾› fallback**ã€‚

#### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨Â `setTimeout`Â æ¨¡æ‹Ÿï¼ˆç®€å•ä½†ä¸ç²¾ç¡®ï¼‰

```javascript
const requestIdleCallback =
  window.requestIdleCallback ||
  function (callback) {
    const start = Date.now();
    return setTimeout(() => {
      callback({
        didTimeout: false,
        timeRemaining: () => Math.max(0, 50 - (Date.now() - start))
      });
    }, 1);
  };

const cancelIdleCallback =
  window.cancelIdleCallback ||
  function (id) {
    clearTimeout(id);
  };
```

#### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨Â `requestAnimationFrame`Â + æ—¶é—´åˆ‡ç‰‡ï¼ˆæ›´æ¥è¿‘åŸç”Ÿè¡Œä¸ºï¼‰

é€‚ç”¨äºéœ€è¦ç²¾ç»†æ§åˆ¶çš„ä»»åŠ¡è°ƒåº¦ï¼ˆå¦‚ React Fiber çš„æ€è·¯ï¼‰ã€‚

#### æ–¹æ¡ˆ 3ï¼šç›´æ¥ä½¿ç”¨Â `setTimeout(fn, 0)`Â æˆ–Â `queueMicrotask`

é€‚ç”¨äºéå…³é”®ä½†éœ€å¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä½†æ— æ³•åˆ©ç”¨â€œç©ºé—²æ—¶é—´â€ã€‚

___

### âš ï¸ æ³¨æ„äº‹é¡¹

1.  **ä¸è¦æ‰§è¡Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡**ï¼šå¦‚ç”¨æˆ·è¾“å…¥å“åº”ã€åŠ¨ç”»æ›´æ–°ã€‚
2.  **é¿å…é•¿æ—¶é—´è¿è¡Œ**ï¼šå³ä½¿Â `timeRemaining()`Â è¿”å›è¾ƒå¤§å€¼ï¼Œä¹Ÿåº”åˆ†ç‰‡å¤„ç†ã€‚
3.  **ä¸è¦ä¾èµ–ç²¾ç¡®æ—¶é—´**ï¼š`timeRemaining()`Â æ˜¯ä¼°ç®—å€¼ï¼Œå¯èƒ½çªç„¶å˜ä¸º 0ã€‚
4.  **ç§»åŠ¨ç«¯æ•ˆæœæœ‰é™**ï¼šä½ç«¯è®¾å¤‡ç©ºé—²æ—¶é—´æå°‘ï¼Œå¯èƒ½é•¿æœŸä¸è§¦å‘ã€‚

___

### ğŸ†š ä¸Â `requestAnimationFrame`Â å¯¹æ¯”

|          API          |        æ—¶æœº         |    ç”¨é€”    |
|-----------------------|-------------------|----------|
| `requestAnimationFrame` | **æ¯ä¸€å¸§å¼€å§‹å‰**ï¼ˆçº¦ 16ms ä¸€æ¬¡ï¼‰ | åŠ¨ç”»ã€è§†è§‰æ›´æ–°  |
|  `requestIdleCallback`  |    **æ¯ä¸€å¸§ç»“æŸåï¼Œè‹¥æœ‰ç©ºé—²**    | ä½ä¼˜å…ˆçº§åå°ä»»åŠ¡ |

> âœ… ä¸¤è€…äº’è¡¥ï¼š`rAF` ä¿è¯æµç•…åŠ¨ç”»ï¼Œ`rIC` é¿å…é˜»å¡åŠ¨ç”»ã€‚

___

### ğŸ“¦ åœ¨ç°ä»£æ¡†æ¶ä¸­çš„ä½¿ç”¨

-   **React**ï¼šå†…éƒ¨è°ƒåº¦å™¨å—Â `rIC`Â å¯å‘ï¼Œä½†ä½¿ç”¨è‡ªå®šä¹‰å®ç°ï¼ˆå› å…¼å®¹æ€§é—®é¢˜ï¼‰ã€‚
-   **Vue / Svelte**ï¼šä¸€èˆ¬ä¸ç›´æ¥ä½¿ç”¨ï¼Œä½†å¯ç”¨äºè‡ªå®šä¹‰æ€§èƒ½ä¼˜åŒ–é€»è¾‘ã€‚
-   **æ¨è**ï¼šåœ¨ä¸šåŠ¡ä»£ç ä¸­è°¨æ…ä½¿ç”¨ï¼Œå¹¶åšå¥½é™çº§ã€‚

___

### âœ… æœ€ä½³å®è·µæ¨¡æ¿

```javascript
function scheduleIdleWork(workFn, timeout = 2000) {
  if ('requestIdleCallback' in window) {
    return requestIdleCallback((deadline) => {
      if (deadline.timeRemaining() > 0 || deadline.didTimeout) {
        workFn();
      }
    }, { timeout });
  } else {
    // fallback: ç¨åæ‰§è¡Œï¼ˆä¸é˜»å¡å½“å‰ä»»åŠ¡ï¼‰
    return setTimeout(workFn, 0);
  }
}

// ä½¿ç”¨
const id = scheduleIdleWork(() => {
  console.log('åœ¨ç©ºé—²æ—¶æ‰§è¡Œ');
});

// å–æ¶ˆï¼ˆå¦‚ç»„ä»¶å¸è½½æ—¶ï¼‰
// cancelIdleCallback(id) æˆ– clearTimeout(id)
```

___

### ğŸ”š æ€»ç»“

-   **ä½œç”¨**ï¼šåœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚
    
-   **ç°çŠ¶**ï¼š**ä»… Chrome/Edge æ”¯æŒ**ï¼ŒFirefox/Safari å·²æ”¾å¼ƒã€‚
    
-   **å»ºè®®**ï¼š
    
    -   å¯ç”¨äº**éå…³é”®ä¼˜åŒ–**ï¼ˆå¦‚é¢„åŠ è½½ã€æ—¥å¿—ä¸ŠæŠ¥ï¼‰ã€‚
    -   **å¿…é¡»æä¾›é™çº§æ–¹æ¡ˆ**ã€‚
    -   ä¸è¦ç”¨äºæ ¸å¿ƒåŠŸèƒ½ã€‚

## 9.AbortController

`AbortController` æ˜¯ Web å¹³å°æä¾›çš„ä¸€ä¸ªæ ‡å‡†æ¥å£ï¼Œç”¨äº**ä¸­æ­¢ï¼ˆå–æ¶ˆï¼‰ä¸€ä¸ªæˆ–å¤šä¸ªå¼‚æ­¥æ“ä½œ**ï¼Œæ¯”å¦‚ `fetch()` è¯·æ±‚ã€å®šæ—¶å™¨ã€è‡ªå®šä¹‰ä»»åŠ¡ç­‰ã€‚å®ƒæä¾›äº†ä¸€ç§ç»Ÿä¸€ã€å¯ç»„åˆçš„æ–¹å¼æ¥å¤„ç†å–æ¶ˆé€»è¾‘ï¼Œé¿å…å†…å­˜æ³„æ¼æˆ–æ— æ•ˆæ“ä½œã€‚

___

### ğŸ§  æ ¸å¿ƒæ¦‚å¿µ

-   **`AbortController`**ï¼šæ§åˆ¶å™¨å¯¹è±¡ï¼Œç”¨äºè§¦å‘ä¸­æ­¢ã€‚
-   **`AbortSignal`**ï¼šä¿¡å·å¯¹è±¡ï¼Œä¸æ§åˆ¶å™¨å…³è”ï¼Œä¼ é€’â€œæ˜¯å¦å·²ä¸­æ­¢â€çš„çŠ¶æ€ï¼Œå¹¶å¯ç›‘å¬Â `abort`Â äº‹ä»¶ã€‚

___

### âœ… åŸºæœ¬ç”¨æ³•

#### 1\. åˆ›å»ºæ§åˆ¶å™¨å’Œä¿¡å·

```cpp
const controller = new AbortController();
const signal = controller.signal; // åªè¯»çš„ AbortSignal
```

#### 2\. ç›‘å¬ä¸­æ­¢ä¿¡å·ï¼ˆåœ¨å¼‚æ­¥æ“ä½œä¸­ï¼‰

```javascript
// ç¤ºä¾‹ï¼šè‡ªå®šä¹‰å¼‚æ­¥ä»»åŠ¡
function myAsyncTask(signal) {
  return new Promise((resolve, reject) => {
    // æ£€æŸ¥æ˜¯å¦å·²ç»ä¸­æ­¢
    if (signal.aborted) {
      reject(new DOMException('æ“ä½œå·²ä¸­æ­¢', 'AbortError'));
      return;
    }

    // ç›‘å¬ä¸­æ­¢äº‹ä»¶
    signal.addEventListener('abort', () => {
      reject(new DOMException('æ“ä½œå·²ä¸­æ­¢', 'AbortError'));
    });

    // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
    const timer = setTimeout(() => {
      resolve('ä»»åŠ¡å®Œæˆ');
    }, 3000);

    // å¯é€‰ï¼šåœ¨ä¸­æ­¢æ—¶æ¸…ç†èµ„æº
    signal.addEventListener('abort', () => {
      clearTimeout(timer);
    });
  });
}
```

#### 3\. è§¦å‘ä¸­æ­¢

```javascript
myAsyncTask(controller.signal)
  .then(console.log)
  .catch(e => {
    if (e.name === 'AbortError') {
      console.log('ä»»åŠ¡è¢«ç”¨æˆ·å–æ¶ˆ');
    } else {
      console.error('å…¶ä»–é”™è¯¯', e);
    }
  });

// 1 ç§’åå–æ¶ˆ
setTimeout(() => {
  controller.abort(); // è§¦å‘ abort äº‹ä»¶ï¼Œsignal.aborted å˜ä¸º true
}, 1000);
```

___

### ğŸŒ å®é™…åº”ç”¨åœºæ™¯

#### 1.Â **å–æ¶ˆÂ `fetch`Â è¯·æ±‚ï¼ˆæœ€å¸¸è§ï¼‰**

```javascript
const controller = new AbortController();

fetch('/api/data', { signal: controller.signal })
  .then(res => res.json())
  .then(data => console.log(data))
  .catch(err => {
    if (err.name === 'AbortError') {
      console.log('è¯·æ±‚è¢«å–æ¶ˆ');
    } else {
      console.error('ç½‘ç»œé”™è¯¯', err);
    }
  });

// å–æ¶ˆè¯·æ±‚
controller.abort();
```

> âœ… æ‰€æœ‰ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒ `fetch` çš„ `signal` é€‰é¡¹ã€‚

___

#### 2.Â **å–æ¶ˆå¤šä¸ªæ“ä½œï¼ˆä¸€å¯¹å¤šï¼‰**

ä¸€ä¸ª `AbortController` å¯ä»¥æ§åˆ¶å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼š

```javascript
const controller = new AbortController();

fetch('/api/1', { signal: controller.signal });
fetch('/api/2', { signal: controller.signal });
myAsyncTask(controller.signal);

// ä¸€é”®å–æ¶ˆæ‰€æœ‰
controller.abort();
```

___

#### 3.Â **ä¸Â `setTimeout`Â /Â `setInterval`Â ç»“åˆ**

è™½ç„¶ `setTimeout` æœ¬èº«ä¸æ”¯æŒ `signal`ï¼Œä½†å¯ä»¥æ‰‹åŠ¨é›†æˆï¼š

```javascript
function delay(ms, signal) {
  return new Promise((resolve, reject) => {
    if (signal?.aborted) {
      reject(new DOMException('å·²ä¸­æ­¢', 'AbortError'));
      return;
    }

    const id = setTimeout(resolve, ms);
    signal?.addEventListener('abort', () => {
      clearTimeout(id);
      reject(new DOMException('å·²ä¸­æ­¢', 'AbortError'));
    });
  });
}

// ä½¿ç”¨
const ctrl = new AbortController();
delay(5000, ctrl.signal).catch(console.error);
ctrl.abort(); // ç«‹å³å–æ¶ˆ
```

___

### ğŸ” ä¸Â `TaskController`ï¼ˆæ¥è‡ªÂ `scheduler.postTask`ï¼‰çš„å…³ç³»

-   `TaskController`Â æ˜¯Â `AbortController`Â çš„**å­ç±»**ï¼Œä¸“ä¸ºè°ƒåº¦ä»»åŠ¡è®¾è®¡ã€‚
-   å®ƒé¢å¤–æ”¯æŒÂ `priority`Â è®¾ç½®ï¼Œå¹¶è¿”å›Â `TaskSignal`ï¼ˆç»§æ‰¿è‡ªÂ `AbortSignal`ï¼‰ã€‚
-   å› æ­¤ï¼Œ`AbortController`Â æ˜¯æ›´é€šç”¨çš„å–æ¶ˆæœºåˆ¶ï¼Œè€ŒÂ `TaskController`Â æ˜¯å…¶åœ¨ä»»åŠ¡è°ƒåº¦åœºæ™¯ä¸‹çš„æ‰©å±•ã€‚

```javascript
// TaskController ç”¨æ³•ï¼ˆå®éªŒæ€§ï¼‰
const taskCtrl = new TaskController({ priority: 'background' });
scheduler.postTask(myTask, { signal: taskCtrl.signal });

// ä¹Ÿå¯ä»¥ç›´æ¥ abort()
taskCtrl.abort();
```

___

### âš ï¸ æ³¨æ„äº‹é¡¹

-   `abort()`Â **åªèƒ½è°ƒç”¨ä¸€æ¬¡**ï¼Œå¤šæ¬¡è°ƒç”¨æ— å‰¯ä½œç”¨ã€‚
-   ä¸­æ­¢åï¼Œ`signal.aborted`Â æ°¸è¿œä¸ºÂ `true`ã€‚
-   è¢«ä¸­æ­¢çš„æ“ä½œ**ä¸ä¼šè‡ªåŠ¨åœæ­¢**ï¼Œä½ éœ€è¦åœ¨ä»£ç ä¸­**ä¸»åŠ¨ç›‘å¬å¹¶æ¸…ç†èµ„æº**ï¼ˆå¦‚æ¸…é™¤å®šæ—¶å™¨ã€å…³é—­æµç­‰ï¼‰ã€‚
-   ä¸è¦é‡å¤ä½¿ç”¨åŒä¸€ä¸ªÂ `AbortController`Â å®ä¾‹å¤„ç†ä¸ç›¸å…³çš„ä»»åŠ¡ï¼Œå»ºè®®æŒ‰é€»è¾‘åˆ†ç»„ä½¿ç”¨ã€‚

### åœ¨Reactä¸­çš„åº”ç”¨

åœ¨ React ä¸­ï¼Œ`AbortController` æ˜¯å¤„ç†**ç»„ä»¶å¸è½½åä»å¯èƒ½å®Œæˆçš„å¼‚æ­¥æ“ä½œ**ï¼ˆå¦‚ `fetch` è¯·æ±‚ã€å®šæ—¶å™¨ã€åŠ¨ç”»ç­‰ï¼‰çš„å…³é”®å·¥å…·ã€‚å®ƒçš„ä¸»è¦ç›®çš„æ˜¯ **é¿å…â€œå†…å­˜æ³„æ¼â€æˆ–â€œçŠ¶æ€æ›´æ–°å·²å¸è½½ç»„ä»¶â€** çš„è­¦å‘Šï¼ˆä¾‹å¦‚ç»å…¸çš„ `Can't perform a React state update on an unmounted component`ï¼‰ã€‚

### âœ… å…¸å‹ä½¿ç”¨åœºæ™¯

#### 1.Â **å–æ¶ˆæ•°æ®è¯·æ±‚ï¼ˆæœ€å¸¸è§ï¼‰**

å½“ç»„ä»¶åœ¨è¯·æ±‚å®Œæˆå‰è¢«å¸è½½ï¼ˆå¦‚ç”¨æˆ·å¿«é€Ÿåˆ‡æ¢è·¯ç”±ï¼‰ï¼Œåº”å–æ¶ˆè¯·æ±‚ã€‚

```javascript
import { useEffect, useState } from 'react';

function UserProfile({ userId }) {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const controller = new AbortController(); // åˆ›å»ºæ§åˆ¶å™¨

    const fetchUser = async () => {
      try {
        const res = await fetch(`/api/users/${userId}`, {
          signal: controller.signal // ä¼ å…¥ signal
        });
        const data = await res.json();
        setUser(data);
      } catch (err) {
        if (err.name !== 'AbortError') {
          console.error('è¯·æ±‚å¤±è´¥:', err);
        }
      } finally {
        setLoading(false);
      }
    };

    fetchUser();

    // æ¸…ç†å‡½æ•°ï¼šç»„ä»¶å¸è½½æ—¶ä¸­æ­¢è¯·æ±‚
    return () => {
      controller.abort();
    };
  }, [userId]);

  if (loading) return <div>åŠ è½½ä¸­...</div>;
  return <div>ç”¨æˆ·åï¼š{user?.name}</div>;
}
```

> âœ… è¿™æ ·å³ä½¿ç»„ä»¶å¸è½½ï¼Œä¹Ÿä¸ä¼šå°è¯•è°ƒç”¨ `setUser`ï¼Œé¿å…è­¦å‘Šã€‚

___

#### 2.Â **å–æ¶ˆå¤šä¸ªå¹¶è¡Œè¯·æ±‚**

```javascript
useEffect(() => {
  const controller = new AbortController();

  Promise.all([
    fetch('/api/posts', { signal: controller.signal }),
    fetch('/api/comments', { signal: controller.signal })
  ])
  .then(/* ... */)
  .catch(err => {
    if (err.name !== 'AbortError') {
      // å¤„ç†çœŸå®é”™è¯¯
    }
  });

  return () => controller.abort();
}, []);
```

___

#### 3.Â **ç»“åˆè‡ªå®šä¹‰ Hook å°è£…**

å¯ä»¥åˆ›å»ºä¸€ä¸ªå¯å¤ç”¨çš„ `useAbortableFetch`ï¼š

```javascript
// hooks/useAbortableFetch.js
import { useEffect, useState } from 'react';

export function useAbortableFetch(url) {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const controller = new AbortController();

    const fetchData = async () => {
      try {
        const res = await fetch(url, { signal: controller.signal });
        if (!res.ok) throw new Error('è¯·æ±‚å¤±è´¥');
        const json = await res.json();
        setData(json);
      } catch (err) {
        if (err.name !== 'AbortError') {
          setError(err);
        }
      } finally {
        setLoading(false);
      }
    };

    fetchData();

    return () => controller.abort();
  }, [url]);

  return { data, loading, error };
}
```

ä½¿ç”¨ï¼š

```csharp
function App() {
  const { data, loading } = useAbortableFetch('/api/data');
  // ...
}
```

___

#### 4.Â **å–æ¶ˆå®šæ—¶å™¨æˆ–åŠ¨ç”»**

è™½ç„¶ `setTimeout` ä¸åŸç”Ÿæ”¯æŒ `signal`ï¼Œä½†å¯ä»¥æ‰‹åŠ¨é›†æˆï¼š

```javascript
useEffect(() => {
  const controller = new AbortController();

  const timer = setTimeout(() => {
    if (!controller.signal.aborted) {
      setData('æ›´æ–°äº†ï¼');
    }
  }, 3000);

  return () => {
    controller.abort(); // æ ‡è®°ä¸ºä¸­æ­¢
    clearTimeout(timer); // æ¸…ç†å®šæ—¶å™¨
  };
}, []);
```

æˆ–è€…å°è£…ä¸€ä¸ªæ”¯æŒ `signal` çš„ `delay` å·¥å…·å‡½æ•°ï¼ˆè§å‰æ–‡ï¼‰ã€‚

___

#### 5.Â **ä¸ React Routerï¼ˆv6ï¼‰ç»“åˆ**

åœ¨è·¯ç”±åˆ‡æ¢æ—¶è‡ªåŠ¨å–æ¶ˆè¯·æ±‚ï¼š

```cpp
// ä¸éœ€è¦é¢å¤–æ“ä½œï¼åªè¦åœ¨ useEffect ä¸­æ­£ç¡®ä½¿ç”¨ AbortControllerï¼Œ
// è·¯ç”±åˆ‡æ¢å¯¼è‡´ç»„ä»¶å¸è½½æ—¶ï¼Œæ¸…ç†å‡½æ•°ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚
```

___

### âš ï¸ æ³¨æ„äº‹é¡¹

1.  **ä¸è¦å¿½ç•¥ `AbortError`**  
    åœ¨ `.catch()` ä¸­è¦åˆ¤æ–­æ˜¯å¦æ˜¯ `AbortError`ï¼Œé¿å…æŠŠâ€œæ­£å¸¸å–æ¶ˆâ€å½“ä½œé”™è¯¯å¤„ç†ã€‚
2.  **æ¯ä¸ª effect ä½¿ç”¨ç‹¬ç«‹çš„ controller**  
    é¿å…å¤šä¸ª effect å…±ç”¨åŒä¸€ä¸ª `AbortController`ï¼Œé™¤éä½ æ˜ç¡®éœ€è¦æ‰¹é‡å–æ¶ˆã€‚
3.  **ä¸é€‚ç”¨äºåŒæ­¥æ“ä½œ**  
    `AbortController` åªå¯¹å¼‚æ­¥ã€å¯ä¸­æ–­çš„æ“ä½œæœ‰æ•ˆã€‚
4.  **React 18 ä¸¥æ ¼æ¨¡å¼ä¸‹çš„åŒé‡è°ƒç”¨**  
    åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼ŒReact 18 çš„ä¸¥æ ¼æ¨¡å¼ä¼šæ•…æ„ mount â†’ unmount â†’ remount ç»„ä»¶ï¼Œæ­¤æ—¶ `AbortController` èƒ½ç¡®ä¿ç¬¬ä¸€æ¬¡è¯·æ±‚è¢«æ­£ç¡®å–æ¶ˆï¼Œæ˜¯**æ­£å¸¸è¡Œä¸º**ï¼Œä¸æ˜¯ bugã€‚

___

### ğŸ”„ æ›¿ä»£æ–¹æ¡ˆï¼ˆç°ä»£ Reactï¼‰

-   **React Query / SWR**ï¼šè¿™äº›æ•°æ®è·å–åº“**å†…éƒ¨å·²é›†æˆå–æ¶ˆé€»è¾‘**ï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†Â `AbortController`ã€‚
-   **useEffect cleanup**ï¼šä»æ˜¯å¤„ç†å–æ¶ˆçš„æ ¸å¿ƒæœºåˆ¶ï¼Œ`AbortController`Â æ˜¯å…¶å®ç°ç»†èŠ‚ä¹‹ä¸€ã€‚

___

### âœ… æ€»ç»“

|            åœºæ™¯            | æ˜¯å¦éœ€è¦Â `AbortController` |
|--------------------------|----------------------|
|         `fetch`Â è¯·æ±‚         |        âœ… å¼ºçƒˆæ¨è        |
| è‡ªå®šä¹‰å¼‚æ­¥ä»»åŠ¡ï¼ˆå¦‚ WebSocketã€å®šæ—¶å™¨ï¼‰ |         âœ… æ¨è         |
|   ä½¿ç”¨ React Query / SWR   |     âŒ ä¸éœ€è¦ï¼ˆåº“å·²å¤„ç†ï¼‰      |
|           åŒæ­¥è®¡ç®—           |        âŒ ä¸é€‚ç”¨         |

> ğŸ’¡ **æœ€ä½³å®è·µ**ï¼šåªè¦ä½ åœ¨ `useEffect` ä¸­å‘èµ·å¼‚æ­¥æ“ä½œå¹¶æ›´æ–°çŠ¶æ€ï¼Œå°±åº”è€ƒè™‘ä½¿ç”¨ `AbortController` æˆ–ç­‰æ•ˆçš„å–æ¶ˆæœºåˆ¶ã€‚
